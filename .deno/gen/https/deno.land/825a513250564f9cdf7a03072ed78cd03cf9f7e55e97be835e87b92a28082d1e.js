// Copyright 2018-2021 the oak authors. All rights reserved. MIT license.
import { BufReader } from "./buf_reader.ts";
import { getFilename } from "./content_disposition.ts";
import { equals, extension, writeAll } from "./deps.ts";
import { readHeaders, toParamRegExp, unquote } from "./headers.ts";
import { httpErrors } from "./httpError.ts";
import { getRandomFilename, skipLWSPChar, stripEol } from "./util.ts";
const decoder = new TextDecoder();
const encoder = new TextEncoder();
const BOUNDARY_PARAM_REGEX = toParamRegExp("boundary", "i");
const DEFAULT_BUFFER_SIZE = 1048576; // 1mb
const DEFAULT_MAX_FILE_SIZE = 10485760; // 10mb
const DEFAULT_MAX_SIZE = 0; // all files written to disc
const NAME_PARAM_REGEX = toParamRegExp("name", "i");
function append(a, b) {
    const ab = new Uint8Array(a.length + b.length);
    ab.set(a, 0);
    ab.set(b, a.length);
    return ab;
}
function isEqual(a, b) {
    return equals(skipLWSPChar(a), b);
}
async function readToStartOrEnd(body, start, end) {
    let lineResult;
    while(lineResult = await body.readLine()){
        if (isEqual(lineResult.bytes, start)) {
            return true;
        }
        if (isEqual(lineResult.bytes, end)) {
            return false;
        }
    }
    throw new httpErrors.BadRequest("Unable to find multi-part boundary.");
}
/** Yield up individual parts by reading the body and parsing out the ford
 * data values. */ async function* parts({ body , final , part , maxFileSize , maxSize , outPath , prefix  }) {
    async function getFile(contentType) {
        const ext = extension(contentType);
        if (!ext) {
            throw new httpErrors.BadRequest(`Invalid media type for part: ${ext}`);
        }
        if (!outPath) {
            outPath = await Deno.makeTempDir();
        }
        const filename = `${outPath}/${await getRandomFilename(prefix, ext)}`;
        const file = await Deno.open(filename, {
            write: true,
            createNew: true
        });
        return [
            filename,
            file
        ];
    }
    while(true){
        const headers = await readHeaders(body);
        const contentType = headers["content-type"];
        const contentDisposition = headers["content-disposition"];
        if (!contentDisposition) {
            throw new httpErrors.BadRequest("Form data part missing content-disposition header");
        }
        if (!contentDisposition.match(/^form-data;/i)) {
            throw new httpErrors.BadRequest(`Unexpected content-disposition header: "${contentDisposition}"`);
        }
        const matches = NAME_PARAM_REGEX.exec(contentDisposition);
        if (!matches) {
            throw new httpErrors.BadRequest(`Unable to determine name of form body part`);
        }
        let [, name] = matches;
        name = unquote(name);
        if (contentType) {
            const originalName = getFilename(contentDisposition);
            let byteLength = 0;
            let file;
            let filename;
            let buf;
            if (maxSize) {
                buf = new Uint8Array();
            } else {
                const result = await getFile(contentType);
                filename = result[0];
                file = result[1];
            }
            while(true){
                const readResult = await body.readLine(false);
                if (!readResult) {
                    throw new httpErrors.BadRequest("Unexpected EOF reached");
                }
                const { bytes  } = readResult;
                const strippedBytes = stripEol(bytes);
                if (isEqual(strippedBytes, part) || isEqual(strippedBytes, final)) {
                    if (file) {
                        // remove extra 2 bytes ([CR, LF]) from result file
                        const bytesDiff = bytes.length - strippedBytes.length;
                        if (bytesDiff) {
                            const originalBytesSize = await file.seek(-bytesDiff, Deno.SeekMode.Current);
                            await file.truncate(originalBytesSize);
                        }
                        file.close();
                    }
                    yield [
                        name,
                        {
                            content: buf,
                            contentType,
                            name,
                            filename,
                            originalName
                        }, 
                    ];
                    if (isEqual(strippedBytes, final)) {
                        return;
                    }
                    break;
                }
                byteLength += bytes.byteLength;
                if (byteLength > maxFileSize) {
                    if (file) {
                        file.close();
                    }
                    throw new httpErrors.RequestEntityTooLarge(`File size exceeds limit of ${maxFileSize} bytes.`);
                }
                if (buf) {
                    if (byteLength > maxSize) {
                        const result = await getFile(contentType);
                        filename = result[0];
                        file = result[1];
                        await writeAll(file, buf);
                        buf = undefined;
                    } else {
                        buf = append(buf, bytes);
                    }
                }
                if (file) {
                    await writeAll(file, bytes);
                }
            }
        } else {
            const lines = [];
            while(true){
                const readResult = await body.readLine();
                if (!readResult) {
                    throw new httpErrors.BadRequest("Unexpected EOF reached");
                }
                const { bytes  } = readResult;
                if (isEqual(bytes, part) || isEqual(bytes, final)) {
                    yield [
                        name,
                        lines.join("\n")
                    ];
                    if (isEqual(bytes, final)) {
                        return;
                    }
                    break;
                }
                lines.push(decoder.decode(bytes));
            }
        }
    }
}
/** A class which provides an interface to access the fields of a
 * `multipart/form-data` body. */ export class FormDataReader {
    #body;
    #boundaryFinal;
    #boundaryPart;
    #reading = false;
    constructor(contentType, body){
        const matches = contentType.match(BOUNDARY_PARAM_REGEX);
        if (!matches) {
            throw new httpErrors.BadRequest(`Content type "${contentType}" does not contain a valid boundary.`);
        }
        let [, boundary] = matches;
        boundary = unquote(boundary);
        this.#boundaryPart = encoder.encode(`--${boundary}`);
        this.#boundaryFinal = encoder.encode(`--${boundary}--`);
        this.#body = body;
    }
    /** Reads the multipart body of the response and resolves with an object which
   * contains fields and files that were part of the response.
   *
   * *Note*: this method handles multiple files with the same `name` attribute
   * in the request, but by design it does not handle multiple fields that share
   * the same `name`.  If you expect the request body to contain multiple form
   * data fields with the same name, it is better to use the `.stream()` method
   * which will iterate over each form data field individually. */ async read(options = {
    }) {
        if (this.#reading) {
            throw new Error("Body is already being read.");
        }
        this.#reading = true;
        const { outPath , maxFileSize =DEFAULT_MAX_FILE_SIZE , maxSize =DEFAULT_MAX_SIZE , bufferSize =DEFAULT_BUFFER_SIZE ,  } = options;
        const body = new BufReader(this.#body, bufferSize);
        const result = {
            fields: {
            }
        };
        if (!await readToStartOrEnd(body, this.#boundaryPart, this.#boundaryFinal)) {
            return result;
        }
        try {
            for await (const part of parts({
                body,
                part: this.#boundaryPart,
                final: this.#boundaryFinal,
                maxFileSize,
                maxSize,
                outPath
            })){
                const [key, value] = part;
                if (typeof value === "string") {
                    result.fields[key] = value;
                } else {
                    if (!result.files) {
                        result.files = [];
                    }
                    result.files.push(value);
                }
            }
        } catch (err) {
            if (err instanceof Deno.errors.PermissionDenied) {
                console.error(err.stack ? err.stack : `${err.name}: ${err.message}`);
            } else {
                throw err;
            }
        }
        return result;
    }
    /** Returns an iterator which will asynchronously yield each part of the form
   * data.  The yielded value is a tuple, where the first element is the name
   * of the part and the second element is a `string` or a `FormDataFile`
   * object. */ async *stream(options = {
    }) {
        if (this.#reading) {
            throw new Error("Body is already being read.");
        }
        this.#reading = true;
        const { outPath , maxFileSize =DEFAULT_MAX_FILE_SIZE , maxSize =DEFAULT_MAX_SIZE , bufferSize =32000 ,  } = options;
        const body = new BufReader(this.#body, bufferSize);
        if (!await readToStartOrEnd(body, this.#boundaryPart, this.#boundaryFinal)) {
            return;
        }
        try {
            for await (const part of parts({
                body,
                part: this.#boundaryPart,
                final: this.#boundaryFinal,
                maxFileSize,
                maxSize,
                outPath
            })){
                yield part;
            }
        } catch (err) {
            if (err instanceof Deno.errors.PermissionDenied) {
                console.error(err.stack ? err.stack : `${err.name}: ${err.message}`);
            } else {
                throw err;
            }
        }
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        return `${this.constructor.name} ${inspect({
        })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrQHYxMC4xLjAvbXVsdGlwYXJ0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjEgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHsgQnVmUmVhZGVyLCBSZWFkTGluZVJlc3VsdCB9IGZyb20gXCIuL2J1Zl9yZWFkZXIudHNcIjtcbmltcG9ydCB7IGdldEZpbGVuYW1lIH0gZnJvbSBcIi4vY29udGVudF9kaXNwb3NpdGlvbi50c1wiO1xuaW1wb3J0IHsgZXF1YWxzLCBleHRlbnNpb24sIHdyaXRlQWxsIH0gZnJvbSBcIi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgcmVhZEhlYWRlcnMsIHRvUGFyYW1SZWdFeHAsIHVucXVvdGUgfSBmcm9tIFwiLi9oZWFkZXJzLnRzXCI7XG5pbXBvcnQgeyBodHRwRXJyb3JzIH0gZnJvbSBcIi4vaHR0cEVycm9yLnRzXCI7XG5pbXBvcnQgeyBnZXRSYW5kb21GaWxlbmFtZSwgc2tpcExXU1BDaGFyLCBzdHJpcEVvbCB9IGZyb20gXCIuL3V0aWwudHNcIjtcblxuY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigpO1xuY29uc3QgZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpO1xuXG5jb25zdCBCT1VOREFSWV9QQVJBTV9SRUdFWCA9IHRvUGFyYW1SZWdFeHAoXCJib3VuZGFyeVwiLCBcImlcIik7XG5jb25zdCBERUZBVUxUX0JVRkZFUl9TSVpFID0gMV8wNDhfNTc2OyAvLyAxbWJcbmNvbnN0IERFRkFVTFRfTUFYX0ZJTEVfU0laRSA9IDEwXzQ4NV83NjA7IC8vIDEwbWJcbmNvbnN0IERFRkFVTFRfTUFYX1NJWkUgPSAwOyAvLyBhbGwgZmlsZXMgd3JpdHRlbiB0byBkaXNjXG5jb25zdCBOQU1FX1BBUkFNX1JFR0VYID0gdG9QYXJhbVJlZ0V4cChcIm5hbWVcIiwgXCJpXCIpO1xuXG5leHBvcnQgaW50ZXJmYWNlIEZvcm1EYXRhQm9keSB7XG4gIC8qKiBBIHJlY29yZCBvZiBmb3JtIHBhcnRzIHdoZXJlIHRoZSBrZXkgd2FzIHRoZSBgbmFtZWAgb2YgdGhlIHBhcnQgYW5kIHRoZVxuICAgKiB2YWx1ZSB3YXMgdGhlIHZhbHVlIG9mIHRoZSBwYXJ0LiBUaGlzIHJlY29yZCBkb2VzIG5vdCBpbmNsdWRlIGFueSBmaWxlc1xuICAgKiB0aGF0IHdlcmUgcGFydCBvZiB0aGUgZm9ybSBkYXRhLlxuICAgKlxuICAgKiAqTm90ZSo6IER1cGxpY2F0ZSBuYW1lcyBhcmUgbm90IGluY2x1ZGVkIGluIHRoaXMgcmVjb3JkLCBpZiB0aGVyZSBhcmVcbiAgICogZHVwbGljYXRlcywgdGhlIGxhc3QgdmFsdWUgd2lsbCBiZSB0aGUgdmFsdWUgdGhhdCBpcyBzZXQgaGVyZS4gIElmIHRoZXJlXG4gICAqIGlzIGEgcG9zc2liaWxpdHkgb2YgZHVwbGljYXRlIHZhbHVlcywgdXNlIHRoZSBgLnN0cmVhbSgpYCBtZXRob2QgdG9cbiAgICogaXRlcmF0ZSBvdmVyIHRoZSB2YWx1ZXMuICovXG4gIGZpZWxkczogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcblxuICAvKiogQW4gYXJyYXkgb2YgYW55IGZpbGVzIHRoYXQgd2VyZSBwYXJ0IG9mIHRoZSBmb3JtIGRhdGEuICovXG4gIGZpbGVzPzogRm9ybURhdGFGaWxlW107XG59XG5cbi8qKiBBIHJlcHJlc2VudGF0aW9uIG9mIGEgZmlsZSB0aGF0IGhhcyBiZWVuIHJlYWQgZnJvbSBhIGZvcm0gZGF0YSBib2R5LiAqL1xuZXhwb3J0IHR5cGUgRm9ybURhdGFGaWxlID0ge1xuICAvKiogV2hlbiB0aGUgZmlsZSBoYXMgbm90IGJlZW4gd3JpdHRlbiBvdXQgdG8gZGlzYywgdGhlIGNvbnRlbnRzIG9mIHRoZSBmaWxlXG4gICAqIGFzIGEgYFVpbnQ4QXJyYXlgLiAqL1xuICBjb250ZW50PzogVWludDhBcnJheTtcblxuICAvKiogVGhlIGNvbnRlbnQgdHlwZSBvZyB0aGUgZm9ybSBkYXRhIGZpbGUuICovXG4gIGNvbnRlbnRUeXBlOiBzdHJpbmc7XG5cbiAgLyoqIFdoZW4gdGhlIGZpbGUgaGFzIGJlZW4gd3JpdHRlbiBvdXQgdG8gZGlzYywgdGhlIGZ1bGwgcGF0aCB0byB0aGUgZmlsZS4gKi9cbiAgZmlsZW5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqIFRoZSBgbmFtZWAgdGhhdCB3YXMgYXNzaWduZWQgdG8gdGhlIGZvcm0gZGF0YSBmaWxlLiAqL1xuICBuYW1lOiBzdHJpbmc7XG5cbiAgLyoqIFRoZSBgZmlsZW5hbWVgIHRoYXQgd2FzIHByb3ZpZGVkIGluIHRoZSBmb3JtIGRhdGEgZmlsZS4gKi9cbiAgb3JpZ2luYWxOYW1lOiBzdHJpbmc7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEZvcm1EYXRhUmVhZE9wdGlvbnMge1xuICAvKiogVGhlIHNpemUgb2YgdGhlIGJ1ZmZlciB0byByZWFkIGZyb20gdGhlIHJlcXVlc3QgYm9keSBhdCBhIHNpbmdsZSB0aW1lLlxuICAgKiBUaGlzIGRlZmF1bHRzIHRvIDFtYi4gKi9cbiAgYnVmZmVyU2l6ZT86IG51bWJlcjtcblxuICAvKiogVGhlIG1heGltdW0gZmlsZSBzaXplIHRoYXQgY2FuIGJlIGhhbmRsZWQuICBUaGlzIGRlZmF1bHRzIHRvIDEwTUIgd2hlblxuICAgKiBub3Qgc3BlY2lmaWVkLiAgVGhpcyBpcyB0byB0cnkgdG8gYXZvaWQgRE9TIGF0dGFja3Mgd2hlcmUgc29tZW9uZSB3b3VsZFxuICAgKiBjb250aW51ZSB0byB0cnkgdG8gc2VuZCBhIFwiZmlsZVwiIGNvbnRpbnVvdXNseSB1bnRpbCBhIGhvc3QgbGltaXQgd2FzXG4gICAqIHJlYWNoZWQgY3Jhc2hpbmcgdGhlIHNlcnZlciBvciB0aGUgaG9zdC4gKi9cbiAgbWF4RmlsZVNpemU/OiBudW1iZXI7XG5cbiAgLyoqIFRoZSBtYXhpbXVtIHNpemUgb2YgYSBmaWxlIHRvIGhvbGQgaW4gbWVtb3J5LCBhbmQgbm90IHdyaXRlIHRvIGRpc2suIFRoaXNcbiAgICogZGVmYXVsdHMgdG8gYDBgLCBzbyB0aGF0IGFsbCBtdWx0aXBhcnQgZm9ybSBmaWxlcyBhcmUgd3JpdHRlbiB0byBkaXNrLlxuICAgKiBXaGVuIHNldCB0byBhIHBvc2l0aXZlIGludGVnZXIsIGlmIHRoZSBmb3JtIGRhdGEgZmlsZSBpcyBzbWFsbGVyLCBpdCB3aWxsXG4gICAqIGJlIHJldGFpbmVkIGluIG1lbW9yeSBhbmQgYXZhaWxhYmxlIGluIHRoZSBgLmNvbnRlbnRgIHByb3BlcnR5IG9mIHRoZVxuICAgKiBgRm9ybURhdGFGaWxlYCBvYmplY3QuICBJZiB0aGUgZmlsZSBleGNlZWRzIHRoZSBgbWF4U2l6ZWAgaXQgd2lsbCBiZVxuICAgKiB3cml0dGVuIHRvIGRpc2sgYW5kIHRoZSBgZmlsZW5hbWVgIGZpbGUgd2lsbCBjb250YWluIHRoZSBmdWxsIHBhdGggdG8gdGhlXG4gICAqIG91dHB1dCBmaWxlLiAqL1xuICBtYXhTaXplPzogbnVtYmVyO1xuXG4gIC8qKiBXaGVuIHdyaXRpbmcgZm9ybSBkYXRhIGZpbGVzIHRvIGRpc2ssIHRoZSBvdXRwdXQgcGF0aC4gIFRoaXMgd2lsbCBkZWZhdWx0XG4gICAqIHRvIGEgdGVtcG9yYXJ5IHBhdGggZ2VuZXJhdGVkIGJ5IGBEZW5vLm1ha2VUZW1wRGlyKClgLiAqL1xuICBvdXRQYXRoPzogc3RyaW5nO1xuXG4gIC8qKiBXaGVuIGEgZm9ybSBkYXRhIGZpbGUgaXMgd3JpdHRlbiB0byBkaXNrLCBpdCB3aWxsIGJlIGdlbmVyYXRlZCB3aXRoIGFcbiAgICogcmFuZG9tIGZpbGVuYW1lIGFuZCBoYXZlIGFuIGV4dGVuc2lvbiBiYXNlZCBvZmYgdGhlIGNvbnRlbnQgdHlwZSBmb3IgdGhlXG4gICAqIGZpbGUuICBgcHJlZml4YCBjYW4gYmUgc3BlY2lmaWVkIHRob3VnaCB0byBwcmVwZW5kIHRvIHRoZSBmaWxlIG5hbWUuICovXG4gIHByZWZpeD86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFBhcnRzT3B0aW9ucyB7XG4gIGJvZHk6IEJ1ZlJlYWRlcjtcbiAgZmluYWw6IFVpbnQ4QXJyYXk7XG4gIG1heEZpbGVTaXplOiBudW1iZXI7XG4gIG1heFNpemU6IG51bWJlcjtcbiAgb3V0UGF0aD86IHN0cmluZztcbiAgcGFydDogVWludDhBcnJheTtcbiAgcHJlZml4Pzogc3RyaW5nO1xufVxuXG5mdW5jdGlvbiBhcHBlbmQoYTogVWludDhBcnJheSwgYjogVWludDhBcnJheSk6IFVpbnQ4QXJyYXkge1xuICBjb25zdCBhYiA9IG5ldyBVaW50OEFycmF5KGEubGVuZ3RoICsgYi5sZW5ndGgpO1xuICBhYi5zZXQoYSwgMCk7XG4gIGFiLnNldChiLCBhLmxlbmd0aCk7XG4gIHJldHVybiBhYjtcbn1cblxuZnVuY3Rpb24gaXNFcXVhbChhOiBVaW50OEFycmF5LCBiOiBVaW50OEFycmF5KTogYm9vbGVhbiB7XG4gIHJldHVybiBlcXVhbHMoc2tpcExXU1BDaGFyKGEpLCBiKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVhZFRvU3RhcnRPckVuZChcbiAgYm9keTogQnVmUmVhZGVyLFxuICBzdGFydDogVWludDhBcnJheSxcbiAgZW5kOiBVaW50OEFycmF5LFxuKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIGxldCBsaW5lUmVzdWx0OiBSZWFkTGluZVJlc3VsdCB8IG51bGw7XG4gIHdoaWxlICgobGluZVJlc3VsdCA9IGF3YWl0IGJvZHkucmVhZExpbmUoKSkpIHtcbiAgICBpZiAoaXNFcXVhbChsaW5lUmVzdWx0LmJ5dGVzLCBzdGFydCkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoaXNFcXVhbChsaW5lUmVzdWx0LmJ5dGVzLCBlbmQpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG4gIHRocm93IG5ldyBodHRwRXJyb3JzLkJhZFJlcXVlc3QoXG4gICAgXCJVbmFibGUgdG8gZmluZCBtdWx0aS1wYXJ0IGJvdW5kYXJ5LlwiLFxuICApO1xufVxuXG4vKiogWWllbGQgdXAgaW5kaXZpZHVhbCBwYXJ0cyBieSByZWFkaW5nIHRoZSBib2R5IGFuZCBwYXJzaW5nIG91dCB0aGUgZm9yZFxuICogZGF0YSB2YWx1ZXMuICovXG5hc3luYyBmdW5jdGlvbiogcGFydHMoXG4gIHsgYm9keSwgZmluYWwsIHBhcnQsIG1heEZpbGVTaXplLCBtYXhTaXplLCBvdXRQYXRoLCBwcmVmaXggfTogUGFydHNPcHRpb25zLFxuKTogQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZyB8IEZvcm1EYXRhRmlsZV0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZ2V0RmlsZShjb250ZW50VHlwZTogc3RyaW5nKTogUHJvbWlzZTxbc3RyaW5nLCBEZW5vLkZpbGVdPiB7XG4gICAgY29uc3QgZXh0ID0gZXh0ZW5zaW9uKGNvbnRlbnRUeXBlKTtcbiAgICBpZiAoIWV4dCkge1xuICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChgSW52YWxpZCBtZWRpYSB0eXBlIGZvciBwYXJ0OiAke2V4dH1gKTtcbiAgICB9XG4gICAgaWYgKCFvdXRQYXRoKSB7XG4gICAgICBvdXRQYXRoID0gYXdhaXQgRGVuby5tYWtlVGVtcERpcigpO1xuICAgIH1cbiAgICBjb25zdCBmaWxlbmFtZSA9IGAke291dFBhdGh9LyR7YXdhaXQgZ2V0UmFuZG9tRmlsZW5hbWUocHJlZml4LCBleHQpfWA7XG4gICAgY29uc3QgZmlsZSA9IGF3YWl0IERlbm8ub3BlbihmaWxlbmFtZSwgeyB3cml0ZTogdHJ1ZSwgY3JlYXRlTmV3OiB0cnVlIH0pO1xuICAgIHJldHVybiBbZmlsZW5hbWUsIGZpbGVdO1xuICB9XG5cbiAgd2hpbGUgKHRydWUpIHtcbiAgICBjb25zdCBoZWFkZXJzID0gYXdhaXQgcmVhZEhlYWRlcnMoYm9keSk7XG4gICAgY29uc3QgY29udGVudFR5cGUgPSBoZWFkZXJzW1wiY29udGVudC10eXBlXCJdO1xuICAgIGNvbnN0IGNvbnRlbnREaXNwb3NpdGlvbiA9IGhlYWRlcnNbXCJjb250ZW50LWRpc3Bvc2l0aW9uXCJdO1xuICAgIGlmICghY29udGVudERpc3Bvc2l0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFxuICAgICAgICBcIkZvcm0gZGF0YSBwYXJ0IG1pc3NpbmcgY29udGVudC1kaXNwb3NpdGlvbiBoZWFkZXJcIixcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICghY29udGVudERpc3Bvc2l0aW9uLm1hdGNoKC9eZm9ybS1kYXRhOy9pKSkge1xuICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcbiAgICAgICAgYFVuZXhwZWN0ZWQgY29udGVudC1kaXNwb3NpdGlvbiBoZWFkZXI6IFwiJHtjb250ZW50RGlzcG9zaXRpb259XCJgLFxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgbWF0Y2hlcyA9IE5BTUVfUEFSQU1fUkVHRVguZXhlYyhjb250ZW50RGlzcG9zaXRpb24pO1xuICAgIGlmICghbWF0Y2hlcykge1xuICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcbiAgICAgICAgYFVuYWJsZSB0byBkZXRlcm1pbmUgbmFtZSBvZiBmb3JtIGJvZHkgcGFydGAsXG4gICAgICApO1xuICAgIH1cbiAgICBsZXQgWywgbmFtZV0gPSBtYXRjaGVzO1xuICAgIG5hbWUgPSB1bnF1b3RlKG5hbWUpO1xuICAgIGlmIChjb250ZW50VHlwZSkge1xuICAgICAgY29uc3Qgb3JpZ2luYWxOYW1lID0gZ2V0RmlsZW5hbWUoY29udGVudERpc3Bvc2l0aW9uKTtcbiAgICAgIGxldCBieXRlTGVuZ3RoID0gMDtcbiAgICAgIGxldCBmaWxlOiBEZW5vLkZpbGUgfCB1bmRlZmluZWQ7XG4gICAgICBsZXQgZmlsZW5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgIGxldCBidWY6IFVpbnQ4QXJyYXkgfCB1bmRlZmluZWQ7XG4gICAgICBpZiAobWF4U2l6ZSkge1xuICAgICAgICBidWYgPSBuZXcgVWludDhBcnJheSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2V0RmlsZShjb250ZW50VHlwZSk7XG4gICAgICAgIGZpbGVuYW1lID0gcmVzdWx0WzBdO1xuICAgICAgICBmaWxlID0gcmVzdWx0WzFdO1xuICAgICAgfVxuICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgY29uc3QgcmVhZFJlc3VsdCA9IGF3YWl0IGJvZHkucmVhZExpbmUoZmFsc2UpO1xuICAgICAgICBpZiAoIXJlYWRSZXN1bHQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFwiVW5leHBlY3RlZCBFT0YgcmVhY2hlZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7IGJ5dGVzIH0gPSByZWFkUmVzdWx0O1xuICAgICAgICBjb25zdCBzdHJpcHBlZEJ5dGVzID0gc3RyaXBFb2woYnl0ZXMpO1xuICAgICAgICBpZiAoaXNFcXVhbChzdHJpcHBlZEJ5dGVzLCBwYXJ0KSB8fCBpc0VxdWFsKHN0cmlwcGVkQnl0ZXMsIGZpbmFsKSkge1xuICAgICAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgICAgICAvLyByZW1vdmUgZXh0cmEgMiBieXRlcyAoW0NSLCBMRl0pIGZyb20gcmVzdWx0IGZpbGVcbiAgICAgICAgICAgIGNvbnN0IGJ5dGVzRGlmZiA9IGJ5dGVzLmxlbmd0aCAtIHN0cmlwcGVkQnl0ZXMubGVuZ3RoO1xuICAgICAgICAgICAgaWYgKGJ5dGVzRGlmZikge1xuICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbEJ5dGVzU2l6ZSA9IGF3YWl0IGZpbGUuc2VlayhcbiAgICAgICAgICAgICAgICAtYnl0ZXNEaWZmLFxuICAgICAgICAgICAgICAgIERlbm8uU2Vla01vZGUuQ3VycmVudCxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgYXdhaXQgZmlsZS50cnVuY2F0ZShvcmlnaW5hbEJ5dGVzU2l6ZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZpbGUuY2xvc2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgeWllbGQgW1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgY29udGVudDogYnVmLFxuICAgICAgICAgICAgICBjb250ZW50VHlwZSxcbiAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgZmlsZW5hbWUsXG4gICAgICAgICAgICAgIG9yaWdpbmFsTmFtZSxcbiAgICAgICAgICAgIH0gYXMgRm9ybURhdGFGaWxlLFxuICAgICAgICAgIF07XG4gICAgICAgICAgaWYgKGlzRXF1YWwoc3RyaXBwZWRCeXRlcywgZmluYWwpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGJ5dGVMZW5ndGggKz0gYnl0ZXMuYnl0ZUxlbmd0aDtcbiAgICAgICAgaWYgKGJ5dGVMZW5ndGggPiBtYXhGaWxlU2l6ZSkge1xuICAgICAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgICAgICBmaWxlLmNsb3NlKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRocm93IG5ldyBodHRwRXJyb3JzLlJlcXVlc3RFbnRpdHlUb29MYXJnZShcbiAgICAgICAgICAgIGBGaWxlIHNpemUgZXhjZWVkcyBsaW1pdCBvZiAke21heEZpbGVTaXplfSBieXRlcy5gLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJ1Zikge1xuICAgICAgICAgIGlmIChieXRlTGVuZ3RoID4gbWF4U2l6ZSkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2V0RmlsZShjb250ZW50VHlwZSk7XG4gICAgICAgICAgICBmaWxlbmFtZSA9IHJlc3VsdFswXTtcbiAgICAgICAgICAgIGZpbGUgPSByZXN1bHRbMV07XG4gICAgICAgICAgICBhd2FpdCB3cml0ZUFsbChmaWxlLCBidWYpO1xuICAgICAgICAgICAgYnVmID0gdW5kZWZpbmVkO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBidWYgPSBhcHBlbmQoYnVmLCBieXRlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgICAgYXdhaXQgd3JpdGVBbGwoZmlsZSwgYnl0ZXMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGxpbmVzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgY29uc3QgcmVhZFJlc3VsdCA9IGF3YWl0IGJvZHkucmVhZExpbmUoKTtcbiAgICAgICAgaWYgKCFyZWFkUmVzdWx0KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcIlVuZXhwZWN0ZWQgRU9GIHJlYWNoZWRcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBieXRlcyB9ID0gcmVhZFJlc3VsdDtcbiAgICAgICAgaWYgKGlzRXF1YWwoYnl0ZXMsIHBhcnQpIHx8IGlzRXF1YWwoYnl0ZXMsIGZpbmFsKSkge1xuICAgICAgICAgIHlpZWxkIFtuYW1lLCBsaW5lcy5qb2luKFwiXFxuXCIpXTtcbiAgICAgICAgICBpZiAoaXNFcXVhbChieXRlcywgZmluYWwpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGxpbmVzLnB1c2goZGVjb2Rlci5kZWNvZGUoYnl0ZXMpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLyoqIEEgY2xhc3Mgd2hpY2ggcHJvdmlkZXMgYW4gaW50ZXJmYWNlIHRvIGFjY2VzcyB0aGUgZmllbGRzIG9mIGFcbiAqIGBtdWx0aXBhcnQvZm9ybS1kYXRhYCBib2R5LiAqL1xuZXhwb3J0IGNsYXNzIEZvcm1EYXRhUmVhZGVyIHtcbiAgI2JvZHk6IERlbm8uUmVhZGVyO1xuICAjYm91bmRhcnlGaW5hbDogVWludDhBcnJheTtcbiAgI2JvdW5kYXJ5UGFydDogVWludDhBcnJheTtcbiAgI3JlYWRpbmcgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihjb250ZW50VHlwZTogc3RyaW5nLCBib2R5OiBEZW5vLlJlYWRlcikge1xuICAgIGNvbnN0IG1hdGNoZXMgPSBjb250ZW50VHlwZS5tYXRjaChCT1VOREFSWV9QQVJBTV9SRUdFWCk7XG4gICAgaWYgKCFtYXRjaGVzKSB7XG4gICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFxuICAgICAgICBgQ29udGVudCB0eXBlIFwiJHtjb250ZW50VHlwZX1cIiBkb2VzIG5vdCBjb250YWluIGEgdmFsaWQgYm91bmRhcnkuYCxcbiAgICAgICk7XG4gICAgfVxuICAgIGxldCBbLCBib3VuZGFyeV0gPSBtYXRjaGVzO1xuICAgIGJvdW5kYXJ5ID0gdW5xdW90ZShib3VuZGFyeSk7XG4gICAgdGhpcy4jYm91bmRhcnlQYXJ0ID0gZW5jb2Rlci5lbmNvZGUoYC0tJHtib3VuZGFyeX1gKTtcbiAgICB0aGlzLiNib3VuZGFyeUZpbmFsID0gZW5jb2Rlci5lbmNvZGUoYC0tJHtib3VuZGFyeX0tLWApO1xuICAgIHRoaXMuI2JvZHkgPSBib2R5O1xuICB9XG5cbiAgLyoqIFJlYWRzIHRoZSBtdWx0aXBhcnQgYm9keSBvZiB0aGUgcmVzcG9uc2UgYW5kIHJlc29sdmVzIHdpdGggYW4gb2JqZWN0IHdoaWNoXG4gICAqIGNvbnRhaW5zIGZpZWxkcyBhbmQgZmlsZXMgdGhhdCB3ZXJlIHBhcnQgb2YgdGhlIHJlc3BvbnNlLlxuICAgKlxuICAgKiAqTm90ZSo6IHRoaXMgbWV0aG9kIGhhbmRsZXMgbXVsdGlwbGUgZmlsZXMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgYXR0cmlidXRlXG4gICAqIGluIHRoZSByZXF1ZXN0LCBidXQgYnkgZGVzaWduIGl0IGRvZXMgbm90IGhhbmRsZSBtdWx0aXBsZSBmaWVsZHMgdGhhdCBzaGFyZVxuICAgKiB0aGUgc2FtZSBgbmFtZWAuICBJZiB5b3UgZXhwZWN0IHRoZSByZXF1ZXN0IGJvZHkgdG8gY29udGFpbiBtdWx0aXBsZSBmb3JtXG4gICAqIGRhdGEgZmllbGRzIHdpdGggdGhlIHNhbWUgbmFtZSwgaXQgaXMgYmV0dGVyIHRvIHVzZSB0aGUgYC5zdHJlYW0oKWAgbWV0aG9kXG4gICAqIHdoaWNoIHdpbGwgaXRlcmF0ZSBvdmVyIGVhY2ggZm9ybSBkYXRhIGZpZWxkIGluZGl2aWR1YWxseS4gKi9cbiAgYXN5bmMgcmVhZChvcHRpb25zOiBGb3JtRGF0YVJlYWRPcHRpb25zID0ge30pOiBQcm9taXNlPEZvcm1EYXRhQm9keT4ge1xuICAgIGlmICh0aGlzLiNyZWFkaW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCb2R5IGlzIGFscmVhZHkgYmVpbmcgcmVhZC5cIik7XG4gICAgfVxuICAgIHRoaXMuI3JlYWRpbmcgPSB0cnVlO1xuICAgIGNvbnN0IHtcbiAgICAgIG91dFBhdGgsXG4gICAgICBtYXhGaWxlU2l6ZSA9IERFRkFVTFRfTUFYX0ZJTEVfU0laRSxcbiAgICAgIG1heFNpemUgPSBERUZBVUxUX01BWF9TSVpFLFxuICAgICAgYnVmZmVyU2l6ZSA9IERFRkFVTFRfQlVGRkVSX1NJWkUsXG4gICAgfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgYm9keSA9IG5ldyBCdWZSZWFkZXIodGhpcy4jYm9keSwgYnVmZmVyU2l6ZSk7XG4gICAgY29uc3QgcmVzdWx0OiBGb3JtRGF0YUJvZHkgPSB7IGZpZWxkczoge30gfTtcbiAgICBpZiAoXG4gICAgICAhKGF3YWl0IHJlYWRUb1N0YXJ0T3JFbmQoYm9keSwgdGhpcy4jYm91bmRhcnlQYXJ0LCB0aGlzLiNib3VuZGFyeUZpbmFsKSlcbiAgICApIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBmb3IgYXdhaXQgKFxuICAgICAgICBjb25zdCBwYXJ0IG9mIHBhcnRzKHtcbiAgICAgICAgICBib2R5LFxuICAgICAgICAgIHBhcnQ6IHRoaXMuI2JvdW5kYXJ5UGFydCxcbiAgICAgICAgICBmaW5hbDogdGhpcy4jYm91bmRhcnlGaW5hbCxcbiAgICAgICAgICBtYXhGaWxlU2l6ZSxcbiAgICAgICAgICBtYXhTaXplLFxuICAgICAgICAgIG91dFBhdGgsXG4gICAgICAgIH0pXG4gICAgICApIHtcbiAgICAgICAgY29uc3QgW2tleSwgdmFsdWVdID0gcGFydDtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgIHJlc3VsdC5maWVsZHNba2V5XSA9IHZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICghcmVzdWx0LmZpbGVzKSB7XG4gICAgICAgICAgICByZXN1bHQuZmlsZXMgPSBbXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzdWx0LmZpbGVzLnB1c2godmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuUGVybWlzc2lvbkRlbmllZCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5zdGFjayA/IGVyci5zdGFjayA6IGAke2Vyci5uYW1lfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGFuIGl0ZXJhdG9yIHdoaWNoIHdpbGwgYXN5bmNocm9ub3VzbHkgeWllbGQgZWFjaCBwYXJ0IG9mIHRoZSBmb3JtXG4gICAqIGRhdGEuICBUaGUgeWllbGRlZCB2YWx1ZSBpcyBhIHR1cGxlLCB3aGVyZSB0aGUgZmlyc3QgZWxlbWVudCBpcyB0aGUgbmFtZVxuICAgKiBvZiB0aGUgcGFydCBhbmQgdGhlIHNlY29uZCBlbGVtZW50IGlzIGEgYHN0cmluZ2Agb3IgYSBgRm9ybURhdGFGaWxlYFxuICAgKiBvYmplY3QuICovXG4gIGFzeW5jICpzdHJlYW0oXG4gICAgb3B0aW9uczogRm9ybURhdGFSZWFkT3B0aW9ucyA9IHt9LFxuICApOiBBc3luY0l0ZXJhYmxlSXRlcmF0b3I8W3N0cmluZywgc3RyaW5nIHwgRm9ybURhdGFGaWxlXT4ge1xuICAgIGlmICh0aGlzLiNyZWFkaW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCb2R5IGlzIGFscmVhZHkgYmVpbmcgcmVhZC5cIik7XG4gICAgfVxuICAgIHRoaXMuI3JlYWRpbmcgPSB0cnVlO1xuICAgIGNvbnN0IHtcbiAgICAgIG91dFBhdGgsXG4gICAgICBtYXhGaWxlU2l6ZSA9IERFRkFVTFRfTUFYX0ZJTEVfU0laRSxcbiAgICAgIG1heFNpemUgPSBERUZBVUxUX01BWF9TSVpFLFxuICAgICAgYnVmZmVyU2l6ZSA9IDMyMDAwLFxuICAgIH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IGJvZHkgPSBuZXcgQnVmUmVhZGVyKHRoaXMuI2JvZHksIGJ1ZmZlclNpemUpO1xuICAgIGlmIChcbiAgICAgICEoYXdhaXQgcmVhZFRvU3RhcnRPckVuZChib2R5LCB0aGlzLiNib3VuZGFyeVBhcnQsIHRoaXMuI2JvdW5kYXJ5RmluYWwpKVxuICAgICkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgZm9yIGF3YWl0IChcbiAgICAgICAgY29uc3QgcGFydCBvZiBwYXJ0cyh7XG4gICAgICAgICAgYm9keSxcbiAgICAgICAgICBwYXJ0OiB0aGlzLiNib3VuZGFyeVBhcnQsXG4gICAgICAgICAgZmluYWw6IHRoaXMuI2JvdW5kYXJ5RmluYWwsXG4gICAgICAgICAgbWF4RmlsZVNpemUsXG4gICAgICAgICAgbWF4U2l6ZSxcbiAgICAgICAgICBvdXRQYXRoLFxuICAgICAgICB9KVxuICAgICAgKSB7XG4gICAgICAgIHlpZWxkIHBhcnQ7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuUGVybWlzc2lvbkRlbmllZCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5zdGFjayA/IGVyci5zdGFjayA6IGAke2Vyci5uYW1lfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIkRlbm8uY3VzdG9tSW5zcGVjdFwiKV0oaW5zcGVjdDogKHZhbHVlOiB1bmtub3duKSA9PiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSAke2luc3BlY3Qoe30pfWA7XG4gIH1cbn1cbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxFQUF5RSxBQUF6RSx1RUFBeUU7QUFFekUsTUFBTSxHQUFHLFNBQVMsUUFBd0IsQ0FBaUI7QUFDM0QsTUFBTSxHQUFHLFdBQVcsUUFBUSxDQUEwQjtBQUN0RCxNQUFNLEdBQUcsTUFBTSxFQUFFLFNBQVMsRUFBRSxRQUFRLFFBQVEsQ0FBVztBQUN2RCxNQUFNLEdBQUcsV0FBVyxFQUFFLGFBQWEsRUFBRSxPQUFPLFFBQVEsQ0FBYztBQUNsRSxNQUFNLEdBQUcsVUFBVSxRQUFRLENBQWdCO0FBQzNDLE1BQU0sR0FBRyxpQkFBaUIsRUFBRSxZQUFZLEVBQUUsUUFBUSxRQUFRLENBQVc7QUFFckUsS0FBSyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsV0FBVztBQUMvQixLQUFLLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxXQUFXO0FBRS9CLEtBQUssQ0FBQyxvQkFBb0IsR0FBRyxhQUFhLENBQUMsQ0FBVSxXQUFFLENBQUc7QUFDMUQsS0FBSyxDQUFDLG1CQUFtQixHQUFHLE9BQVMsQ0FBRSxDQUFNLEFBQU4sRUFBTSxBQUFOLElBQU07QUFDN0MsS0FBSyxDQUFDLHFCQUFxQixHQUFHLFFBQVUsQ0FBRSxDQUFPLEFBQVAsRUFBTyxBQUFQLEtBQU87QUFDakQsS0FBSyxDQUFDLGdCQUFnQixHQUFHLENBQUMsQ0FBRSxDQUE0QixBQUE1QixFQUE0QixB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