import { RequestBody } from "./body.ts";
import { preferredCharsets } from "./negotiation/charset.ts";
import { preferredEncodings } from "./negotiation/encoding.ts";
import { preferredLanguages } from "./negotiation/language.ts";
import { preferredMediaTypes } from "./negotiation/mediaType.ts";
/** An interface which provides information about the current request. */ export class Request {
    #body;
    #proxy;
    #secure;
    #serverRequest;
    #url;
     #getRemoteAddr() {
        return this.#serverRequest.remoteAddr ?? "";
    }
    /** Is `true` if the request might have a body, otherwise `false`.
   *
   * **WARNING** this is an unreliable API. In HTTP/2 in many situations you
   * cannot determine if a request has a body or not unless you attempt to read
   * the body, due to the streaming nature of HTTP/2. As of Deno 1.16.1, for
   * HTTP/1.1, Deno also reflects that behaviour.  The only reliable way to
   * determine if a request has a body or not is to attempt to read the body.
   */ get hasBody() {
        return this.#body.has();
    }
    /** The `Headers` supplied in the request. */ get headers() {
        return this.#serverRequest.headers;
    }
    /** Request remote address. When the application's `.proxy` is true, the
   * `X-Forwarded-For` will be used to determine the requesting remote address.
   */ get ip() {
        return (this.#proxy ? this.ips[0] : this.#getRemoteAddr()) ?? "";
    }
    /** When the application's `.proxy` is `true`, this will be set to an array of
   * IPs, ordered from upstream to downstream, based on the value of the header
   * `X-Forwarded-For`.  When `false` an empty array is returned. */ get ips() {
        return this.#proxy ? (this.#serverRequest.headers.get("x-forwarded-for") ?? this.#getRemoteAddr()).split(/\s*,\s*/) : [];
    }
    /** The HTTP Method used by the request. */ get method() {
        return this.#serverRequest.method;
    }
    /** Shortcut to `request.url.protocol === "https:"`. */ get secure() {
        return this.#secure;
    }
    /** Set to the value of the _original_ Deno server request. */ get originalRequest() {
        return this.#serverRequest;
    }
    /** A parsed URL for the request which complies with the browser standards.
   * When the application's `.proxy` is `true`, this value will be based off of
   * the `X-Forwarded-Proto` and `X-Forwarded-Host` header values if present in
   * the request. */ get url() {
        if (!this.#url) {
            const serverRequest = this.#serverRequest;
            if (!this.#proxy) {
                // between 1.9.0 and 1.9.1 the request.url of the native HTTP started
                // returning the full URL, where previously it only returned the path
                // so we will try to use that URL here, but default back to old logic
                // if the URL isn't valid.
                try {
                    this.#url = new URL(serverRequest.rawUrl);
                    return this.#url;
                } catch  {
                // we don't care about errors here
                }
            }
            let proto;
            let host;
            if (this.#proxy) {
                proto = serverRequest.headers.get("x-forwarded-proto")?.split(/\s*,\s*/, 1)[0] ?? "http";
                host = (serverRequest.headers.get("x-forwarded-host") ?? serverRequest.headers.get("host")) ?? "";
            } else {
                proto = this.#secure ? "https" : "http";
                host = serverRequest.headers.get("host") ?? "";
            }
            try {
                this.#url = new URL(`${proto}://${host}${serverRequest.url}`);
            } catch  {
                throw new TypeError(`The server request URL of "${proto}://${host}${serverRequest.url}" is invalid.`);
            }
        }
        return this.#url;
    }
    constructor(serverRequest, proxy = false, secure = false){
        this.#proxy = proxy;
        this.#secure = secure;
        this.#serverRequest = serverRequest;
        this.#body = new RequestBody(serverRequest.request);
    }
    accepts(...types) {
        const acceptValue = this.#serverRequest.headers.get("Accept");
        if (!acceptValue) {
            return;
        }
        if (types.length) {
            return preferredMediaTypes(acceptValue, types)[0];
        }
        return preferredMediaTypes(acceptValue);
    }
    acceptsCharsets(...charsets) {
        const acceptCharsetValue = this.#serverRequest.headers.get("Accept-Charset");
        if (!acceptCharsetValue) {
            return;
        }
        if (charsets.length) {
            return preferredCharsets(acceptCharsetValue, charsets)[0];
        }
        return preferredCharsets(acceptCharsetValue);
    }
    acceptsEncodings(...encodings) {
        const acceptEncodingValue = this.#serverRequest.headers.get("Accept-Encoding");
        if (!acceptEncodingValue) {
            return;
        }
        if (encodings.length) {
            return preferredEncodings(acceptEncodingValue, encodings)[0];
        }
        return preferredEncodings(acceptEncodingValue);
    }
    acceptsLanguages(...langs) {
        const acceptLanguageValue = this.#serverRequest.headers.get("Accept-Language");
        if (!acceptLanguageValue) {
            return;
        }
        if (langs.length) {
            return preferredLanguages(acceptLanguageValue, langs)[0];
        }
        return preferredLanguages(acceptLanguageValue);
    }
    body(options = {
    }) {
        return this.#body.get(options);
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        const { hasBody , headers , ip , ips , method , secure , url  } = this;
        return `Request ${inspect({
            hasBody,
            headers,
            ip,
            ips,
            method,
            secure,
            url: url.toString()
        })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrQHYxMC4xLjAvcmVxdWVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIxIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHtcbiAgQm9keSxcbiAgQm9keUJ5dGVzLFxuICBCb2R5Rm9ybSxcbiAgQm9keUZvcm1EYXRhLFxuICBCb2R5SnNvbixcbiAgQm9keU9wdGlvbnMsXG4gIEJvZHlSZWFkZXIsXG4gIEJvZHlTdHJlYW0sXG4gIEJvZHlUZXh0LFxufSBmcm9tIFwiLi9ib2R5LnRzXCI7XG5pbXBvcnQgeyBSZXF1ZXN0Qm9keSB9IGZyb20gXCIuL2JvZHkudHNcIjtcbmltcG9ydCB0eXBlIHsgTmF0aXZlUmVxdWVzdCB9IGZyb20gXCIuL2h0dHBfc2VydmVyX25hdGl2ZS50c1wiO1xuaW1wb3J0IHR5cGUgeyBIVFRQTWV0aG9kcyB9IGZyb20gXCIuL3R5cGVzLmQudHNcIjtcbmltcG9ydCB7IHByZWZlcnJlZENoYXJzZXRzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vY2hhcnNldC50c1wiO1xuaW1wb3J0IHsgcHJlZmVycmVkRW5jb2RpbmdzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vZW5jb2RpbmcudHNcIjtcbmltcG9ydCB7IHByZWZlcnJlZExhbmd1YWdlcyB9IGZyb20gXCIuL25lZ290aWF0aW9uL2xhbmd1YWdlLnRzXCI7XG5pbXBvcnQgeyBwcmVmZXJyZWRNZWRpYVR5cGVzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vbWVkaWFUeXBlLnRzXCI7XG5cbi8qKiBBbiBpbnRlcmZhY2Ugd2hpY2ggcHJvdmlkZXMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGN1cnJlbnQgcmVxdWVzdC4gKi9cbmV4cG9ydCBjbGFzcyBSZXF1ZXN0IHtcbiAgI2JvZHk6IFJlcXVlc3RCb2R5O1xuICAjcHJveHk6IGJvb2xlYW47XG4gICNzZWN1cmU6IGJvb2xlYW47XG4gICNzZXJ2ZXJSZXF1ZXN0OiBOYXRpdmVSZXF1ZXN0O1xuICAjdXJsPzogVVJMO1xuXG4gICNnZXRSZW1vdGVBZGRyKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlcXVlc3QucmVtb3RlQWRkciA/PyBcIlwiO1xuICB9XG5cbiAgLyoqIElzIGB0cnVlYCBpZiB0aGUgcmVxdWVzdCBtaWdodCBoYXZlIGEgYm9keSwgb3RoZXJ3aXNlIGBmYWxzZWAuXG4gICAqXG4gICAqICoqV0FSTklORyoqIHRoaXMgaXMgYW4gdW5yZWxpYWJsZSBBUEkuIEluIEhUVFAvMiBpbiBtYW55IHNpdHVhdGlvbnMgeW91XG4gICAqIGNhbm5vdCBkZXRlcm1pbmUgaWYgYSByZXF1ZXN0IGhhcyBhIGJvZHkgb3Igbm90IHVubGVzcyB5b3UgYXR0ZW1wdCB0byByZWFkXG4gICAqIHRoZSBib2R5LCBkdWUgdG8gdGhlIHN0cmVhbWluZyBuYXR1cmUgb2YgSFRUUC8yLiBBcyBvZiBEZW5vIDEuMTYuMSwgZm9yXG4gICAqIEhUVFAvMS4xLCBEZW5vIGFsc28gcmVmbGVjdHMgdGhhdCBiZWhhdmlvdXIuICBUaGUgb25seSByZWxpYWJsZSB3YXkgdG9cbiAgICogZGV0ZXJtaW5lIGlmIGEgcmVxdWVzdCBoYXMgYSBib2R5IG9yIG5vdCBpcyB0byBhdHRlbXB0IHRvIHJlYWQgdGhlIGJvZHkuXG4gICAqL1xuICBnZXQgaGFzQm9keSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy4jYm9keS5oYXMoKTtcbiAgfVxuXG4gIC8qKiBUaGUgYEhlYWRlcnNgIHN1cHBsaWVkIGluIHRoZSByZXF1ZXN0LiAqL1xuICBnZXQgaGVhZGVycygpOiBIZWFkZXJzIHtcbiAgICByZXR1cm4gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzO1xuICB9XG5cbiAgLyoqIFJlcXVlc3QgcmVtb3RlIGFkZHJlc3MuIFdoZW4gdGhlIGFwcGxpY2F0aW9uJ3MgYC5wcm94eWAgaXMgdHJ1ZSwgdGhlXG4gICAqIGBYLUZvcndhcmRlZC1Gb3JgIHdpbGwgYmUgdXNlZCB0byBkZXRlcm1pbmUgdGhlIHJlcXVlc3RpbmcgcmVtb3RlIGFkZHJlc3MuXG4gICAqL1xuICBnZXQgaXAoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gKHRoaXMuI3Byb3h5ID8gdGhpcy5pcHNbMF0gOiB0aGlzLiNnZXRSZW1vdGVBZGRyKCkpID8/IFwiXCI7XG4gIH1cblxuICAvKiogV2hlbiB0aGUgYXBwbGljYXRpb24ncyBgLnByb3h5YCBpcyBgdHJ1ZWAsIHRoaXMgd2lsbCBiZSBzZXQgdG8gYW4gYXJyYXkgb2ZcbiAgICogSVBzLCBvcmRlcmVkIGZyb20gdXBzdHJlYW0gdG8gZG93bnN0cmVhbSwgYmFzZWQgb24gdGhlIHZhbHVlIG9mIHRoZSBoZWFkZXJcbiAgICogYFgtRm9yd2FyZGVkLUZvcmAuICBXaGVuIGBmYWxzZWAgYW4gZW1wdHkgYXJyYXkgaXMgcmV0dXJuZWQuICovXG4gIGdldCBpcHMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB0aGlzLiNwcm94eVxuICAgICAgPyAodGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcIngtZm9yd2FyZGVkLWZvclwiKSA/P1xuICAgICAgICB0aGlzLiNnZXRSZW1vdGVBZGRyKCkpLnNwbGl0KC9cXHMqLFxccyovKVxuICAgICAgOiBbXTtcbiAgfVxuXG4gIC8qKiBUaGUgSFRUUCBNZXRob2QgdXNlZCBieSB0aGUgcmVxdWVzdC4gKi9cbiAgZ2V0IG1ldGhvZCgpOiBIVFRQTWV0aG9kcyB7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlcXVlc3QubWV0aG9kIGFzIEhUVFBNZXRob2RzO1xuICB9XG5cbiAgLyoqIFNob3J0Y3V0IHRvIGByZXF1ZXN0LnVybC5wcm90b2NvbCA9PT0gXCJodHRwczpcImAuICovXG4gIGdldCBzZWN1cmUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuI3NlY3VyZTtcbiAgfVxuXG4gIC8qKiBTZXQgdG8gdGhlIHZhbHVlIG9mIHRoZSBfb3JpZ2luYWxfIERlbm8gc2VydmVyIHJlcXVlc3QuICovXG4gIGdldCBvcmlnaW5hbFJlcXVlc3QoKTogTmF0aXZlUmVxdWVzdCB7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlcXVlc3Q7XG4gIH1cblxuICAvKiogQSBwYXJzZWQgVVJMIGZvciB0aGUgcmVxdWVzdCB3aGljaCBjb21wbGllcyB3aXRoIHRoZSBicm93c2VyIHN0YW5kYXJkcy5cbiAgICogV2hlbiB0aGUgYXBwbGljYXRpb24ncyBgLnByb3h5YCBpcyBgdHJ1ZWAsIHRoaXMgdmFsdWUgd2lsbCBiZSBiYXNlZCBvZmYgb2ZcbiAgICogdGhlIGBYLUZvcndhcmRlZC1Qcm90b2AgYW5kIGBYLUZvcndhcmRlZC1Ib3N0YCBoZWFkZXIgdmFsdWVzIGlmIHByZXNlbnQgaW5cbiAgICogdGhlIHJlcXVlc3QuICovXG4gIGdldCB1cmwoKTogVVJMIHtcbiAgICBpZiAoIXRoaXMuI3VybCkge1xuICAgICAgY29uc3Qgc2VydmVyUmVxdWVzdCA9IHRoaXMuI3NlcnZlclJlcXVlc3Q7XG4gICAgICBpZiAoIXRoaXMuI3Byb3h5KSB7XG4gICAgICAgIC8vIGJldHdlZW4gMS45LjAgYW5kIDEuOS4xIHRoZSByZXF1ZXN0LnVybCBvZiB0aGUgbmF0aXZlIEhUVFAgc3RhcnRlZFxuICAgICAgICAvLyByZXR1cm5pbmcgdGhlIGZ1bGwgVVJMLCB3aGVyZSBwcmV2aW91c2x5IGl0IG9ubHkgcmV0dXJuZWQgdGhlIHBhdGhcbiAgICAgICAgLy8gc28gd2Ugd2lsbCB0cnkgdG8gdXNlIHRoYXQgVVJMIGhlcmUsIGJ1dCBkZWZhdWx0IGJhY2sgdG8gb2xkIGxvZ2ljXG4gICAgICAgIC8vIGlmIHRoZSBVUkwgaXNuJ3QgdmFsaWQuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdGhpcy4jdXJsID0gbmV3IFVSTChzZXJ2ZXJSZXF1ZXN0LnJhd1VybCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuI3VybDtcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBlcnJvcnMgaGVyZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBsZXQgcHJvdG86IHN0cmluZztcbiAgICAgIGxldCBob3N0OiBzdHJpbmc7XG4gICAgICBpZiAodGhpcy4jcHJveHkpIHtcbiAgICAgICAgcHJvdG8gPSBzZXJ2ZXJSZXF1ZXN0XG4gICAgICAgICAgLmhlYWRlcnMuZ2V0KFwieC1mb3J3YXJkZWQtcHJvdG9cIik/LnNwbGl0KC9cXHMqLFxccyovLCAxKVswXSA/P1xuICAgICAgICAgIFwiaHR0cFwiO1xuICAgICAgICBob3N0ID0gc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcIngtZm9yd2FyZGVkLWhvc3RcIikgPz9cbiAgICAgICAgICBzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiaG9zdFwiKSA/PyBcIlwiO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcHJvdG8gPSB0aGlzLiNzZWN1cmUgPyBcImh0dHBzXCIgOiBcImh0dHBcIjtcbiAgICAgICAgaG9zdCA9IHNlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXCJob3N0XCIpID8/IFwiXCI7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLiN1cmwgPSBuZXcgVVJMKGAke3Byb3RvfTovLyR7aG9zdH0ke3NlcnZlclJlcXVlc3QudXJsfWApO1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgICAgYFRoZSBzZXJ2ZXIgcmVxdWVzdCBVUkwgb2YgXCIke3Byb3RvfTovLyR7aG9zdH0ke3NlcnZlclJlcXVlc3QudXJsfVwiIGlzIGludmFsaWQuYCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuI3VybDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHNlcnZlclJlcXVlc3Q6IE5hdGl2ZVJlcXVlc3QsXG4gICAgcHJveHkgPSBmYWxzZSxcbiAgICBzZWN1cmUgPSBmYWxzZSxcbiAgKSB7XG4gICAgdGhpcy4jcHJveHkgPSBwcm94eTtcbiAgICB0aGlzLiNzZWN1cmUgPSBzZWN1cmU7XG4gICAgdGhpcy4jc2VydmVyUmVxdWVzdCA9IHNlcnZlclJlcXVlc3Q7XG4gICAgdGhpcy4jYm9keSA9IG5ldyBSZXF1ZXN0Qm9keShzZXJ2ZXJSZXF1ZXN0LnJlcXVlc3QpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgbWVkaWEgdHlwZXMsIGFjY2VwdGVkIGJ5IHRoZSByZXF1ZXN0b3IsIGluIG9yZGVyIG9mXG4gICAqIHByZWZlcmVuY2UuICBJZiB0aGVyZSBhcmUgbm8gZW5jb2RpbmdzIHN1cHBsaWVkIGJ5IHRoZSByZXF1ZXN0b3IsXG4gICAqIGB1bmRlZmluZWRgIGlzIHJldHVybmVkLlxuICAgKi9cbiAgYWNjZXB0cygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqIEZvciBhIGdpdmVuIHNldCBvZiBtZWRpYSB0eXBlcywgcmV0dXJuIHRoZSBiZXN0IG1hdGNoIGFjY2VwdGVkIGJ5IHRoZVxuICAgKiByZXF1ZXN0b3IuICBJZiB0aGVyZSBhcmUgbm8gZW5jb2RpbmcgdGhhdCBtYXRjaCwgdGhlbiB0aGUgbWV0aG9kIHJldHVybnNcbiAgICogYHVuZGVmaW5lZGAuXG4gICAqL1xuICBhY2NlcHRzKC4uLnR5cGVzOiBzdHJpbmdbXSk6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYWNjZXB0cyguLi50eXBlczogc3RyaW5nW10pOiBzdHJpbmcgfCBzdHJpbmdbXSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgYWNjZXB0VmFsdWUgPSB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiQWNjZXB0XCIpO1xuICAgIGlmICghYWNjZXB0VmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHR5cGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHByZWZlcnJlZE1lZGlhVHlwZXMoYWNjZXB0VmFsdWUsIHR5cGVzKVswXTtcbiAgICB9XG4gICAgcmV0dXJuIHByZWZlcnJlZE1lZGlhVHlwZXMoYWNjZXB0VmFsdWUpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgY2hhcnNldHMsIGFjY2VwdGVkIGJ5IHRoZSByZXF1ZXN0b3IsIGluIG9yZGVyIG9mXG4gICAqIHByZWZlcmVuY2UuICBJZiB0aGVyZSBhcmUgbm8gY2hhcnNldHMgc3VwcGxpZWQgYnkgdGhlIHJlcXVlc3RvcixcbiAgICogYHVuZGVmaW5lZGAgaXMgcmV0dXJuZWQuXG4gICAqL1xuICBhY2NlcHRzQ2hhcnNldHMoKTogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gIC8qKiBGb3IgYSBnaXZlbiBzZXQgb2YgY2hhcnNldHMsIHJldHVybiB0aGUgYmVzdCBtYXRjaCBhY2NlcHRlZCBieSB0aGVcbiAgICogcmVxdWVzdG9yLiAgSWYgdGhlcmUgYXJlIG5vIGNoYXJzZXRzIHRoYXQgbWF0Y2gsIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zXG4gICAqIGB1bmRlZmluZWRgLiAqL1xuICBhY2NlcHRzQ2hhcnNldHMoLi4uY2hhcnNldHM6IHN0cmluZ1tdKTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBhY2NlcHRzQ2hhcnNldHMoLi4uY2hhcnNldHM6IHN0cmluZ1tdKTogc3RyaW5nW10gfCBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGFjY2VwdENoYXJzZXRWYWx1ZSA9IHRoaXMuI3NlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXG4gICAgICBcIkFjY2VwdC1DaGFyc2V0XCIsXG4gICAgKTtcbiAgICBpZiAoIWFjY2VwdENoYXJzZXRWYWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY2hhcnNldHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcHJlZmVycmVkQ2hhcnNldHMoYWNjZXB0Q2hhcnNldFZhbHVlLCBjaGFyc2V0cylbMF07XG4gICAgfVxuICAgIHJldHVybiBwcmVmZXJyZWRDaGFyc2V0cyhhY2NlcHRDaGFyc2V0VmFsdWUpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgZW5jb2RpbmdzLCBhY2NlcHRlZCBieSB0aGUgcmVxdWVzdG9yLCBpbiBvcmRlciBvZlxuICAgKiBwcmVmZXJlbmNlLiAgSWYgdGhlcmUgYXJlIG5vIGVuY29kaW5ncyBzdXBwbGllZCBieSB0aGUgcmVxdWVzdG9yLFxuICAgKiBgdW5kZWZpbmVkYCBpcyByZXR1cm5lZC5cbiAgICovXG4gIGFjY2VwdHNFbmNvZGluZ3MoKTogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gIC8qKiBGb3IgYSBnaXZlbiBzZXQgb2YgZW5jb2RpbmdzLCByZXR1cm4gdGhlIGJlc3QgbWF0Y2ggYWNjZXB0ZWQgYnkgdGhlXG4gICAqIHJlcXVlc3Rvci4gIElmIHRoZXJlIGFyZSBubyBlbmNvZGluZ3MgdGhhdCBtYXRjaCwgdGhlbiB0aGUgbWV0aG9kIHJldHVybnNcbiAgICogYHVuZGVmaW5lZGAuXG4gICAqXG4gICAqICoqTk9URToqKiBZb3Ugc2hvdWxkIGFsd2F5cyBzdXBwbHkgYGlkZW50aXR5YCBhcyBvbmUgb2YgdGhlIGVuY29kaW5nc1xuICAgKiB0byBlbnN1cmUgdGhhdCB0aGVyZSBpcyBhIG1hdGNoIHdoZW4gdGhlIGBBY2NlcHQtRW5jb2RpbmdgIGhlYWRlciBpcyBwYXJ0XG4gICAqIG9mIHRoZSByZXF1ZXN0LlxuICAgKi9cbiAgYWNjZXB0c0VuY29kaW5ncyguLi5lbmNvZGluZ3M6IHN0cmluZ1tdKTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBhY2NlcHRzRW5jb2RpbmdzKC4uLmVuY29kaW5nczogc3RyaW5nW10pOiBzdHJpbmdbXSB8IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgYWNjZXB0RW5jb2RpbmdWYWx1ZSA9IHRoaXMuI3NlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXG4gICAgICBcIkFjY2VwdC1FbmNvZGluZ1wiLFxuICAgICk7XG4gICAgaWYgKCFhY2NlcHRFbmNvZGluZ1ZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChlbmNvZGluZ3MubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcHJlZmVycmVkRW5jb2RpbmdzKGFjY2VwdEVuY29kaW5nVmFsdWUsIGVuY29kaW5ncylbMF07XG4gICAgfVxuICAgIHJldHVybiBwcmVmZXJyZWRFbmNvZGluZ3MoYWNjZXB0RW5jb2RpbmdWYWx1ZSk7XG4gIH1cblxuICAvKiogUmV0dXJucyBhbiBhcnJheSBvZiBsYW5ndWFnZXMsIGFjY2VwdGVkIGJ5IHRoZSByZXF1ZXN0b3IsIGluIG9yZGVyIG9mXG4gICAqIHByZWZlcmVuY2UuICBJZiB0aGVyZSBhcmUgbm8gbGFuZ3VhZ2VzIHN1cHBsaWVkIGJ5IHRoZSByZXF1ZXN0b3IsXG4gICAqIGB1bmRlZmluZWRgIGlzIHJldHVybmVkLlxuICAgKi9cbiAgYWNjZXB0c0xhbmd1YWdlcygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqIEZvciBhIGdpdmVuIHNldCBvZiBsYW5ndWFnZXMsIHJldHVybiB0aGUgYmVzdCBtYXRjaCBhY2NlcHRlZCBieSB0aGVcbiAgICogcmVxdWVzdG9yLiAgSWYgdGhlcmUgYXJlIG5vIGxhbmd1YWdlcyB0aGF0IG1hdGNoLCB0aGVuIHRoZSBtZXRob2QgcmV0dXJuc1xuICAgKiBgdW5kZWZpbmVkYC4gKi9cbiAgYWNjZXB0c0xhbmd1YWdlcyguLi5sYW5nczogc3RyaW5nW10pOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGFjY2VwdHNMYW5ndWFnZXMoLi4ubGFuZ3M6IHN0cmluZ1tdKTogc3RyaW5nW10gfCBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGFjY2VwdExhbmd1YWdlVmFsdWUgPSB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFxuICAgICAgXCJBY2NlcHQtTGFuZ3VhZ2VcIixcbiAgICApO1xuICAgIGlmICghYWNjZXB0TGFuZ3VhZ2VWYWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAobGFuZ3MubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcHJlZmVycmVkTGFuZ3VhZ2VzKGFjY2VwdExhbmd1YWdlVmFsdWUsIGxhbmdzKVswXTtcbiAgICB9XG4gICAgcmV0dXJuIHByZWZlcnJlZExhbmd1YWdlcyhhY2NlcHRMYW5ndWFnZVZhbHVlKTtcbiAgfVxuXG4gIGJvZHkob3B0aW9uczogQm9keU9wdGlvbnM8XCJieXRlc1wiPik6IEJvZHlCeXRlcztcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcImZvcm1cIj4pOiBCb2R5Rm9ybTtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcImZvcm0tZGF0YVwiPik6IEJvZHlGb3JtRGF0YTtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcImpzb25cIj4pOiBCb2R5SnNvbjtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcInJlYWRlclwiPik6IEJvZHlSZWFkZXI7XG4gIGJvZHkob3B0aW9uczogQm9keU9wdGlvbnM8XCJzdHJlYW1cIj4pOiBCb2R5U3RyZWFtO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwidGV4dFwiPik6IEJvZHlUZXh0O1xuICBib2R5KG9wdGlvbnM/OiBCb2R5T3B0aW9ucyk6IEJvZHk7XG4gIGJvZHkob3B0aW9uczogQm9keU9wdGlvbnMgPSB7fSk6IEJvZHkgfCBCb2R5UmVhZGVyIHwgQm9keVN0cmVhbSB7XG4gICAgcmV0dXJuIHRoaXMuI2JvZHkuZ2V0KG9wdGlvbnMpO1xuICB9XG5cbiAgW1N5bWJvbC5mb3IoXCJEZW5vLmN1c3RvbUluc3BlY3RcIildKGluc3BlY3Q6ICh2YWx1ZTogdW5rbm93bikgPT4gc3RyaW5nKSB7XG4gICAgY29uc3QgeyBoYXNCb2R5LCBoZWFkZXJzLCBpcCwgaXBzLCBtZXRob2QsIHNlY3VyZSwgdXJsIH0gPSB0aGlzO1xuICAgIHJldHVybiBgUmVxdWVzdCAke1xuICAgICAgaW5zcGVjdCh7XG4gICAgICAgIGhhc0JvZHksXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGlwLFxuICAgICAgICBpcHMsXG4gICAgICAgIG1ldGhvZCxcbiAgICAgICAgc2VjdXJlLFxuICAgICAgICB1cmw6IHVybC50b1N0cmluZygpLFxuICAgICAgfSlcbiAgICB9YDtcbiAgfVxufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWFBLE1BQU0sR0FBRyxXQUFXLFFBQVEsQ0FBVztBQUd2QyxNQUFNLEdBQUcsaUJBQWlCLFFBQVEsQ0FBMEI7QUFDNUQsTUFBTSxHQUFHLGtCQUFrQixRQUFRLENBQTJCO0FBQzlELE1BQU0sR0FBRyxrQkFBa0IsUUFBUSxDQUEyQjtBQUM5RCxNQUFNLEdBQUcsbUJBQW1CLFFBQVEsQ0FBNEI7QUFFaEUsRUFBeUUsQUFBekUscUVBQXlFLEFBQXpFLEVBQXlFLENBQ3pFLE1BQU0sT0FBTyxPQUFPO0lBQ2xCLENBQUMsSUFBSTtJQUNMLENBQUMsS0FBSztJQUNOLENBQUMsTUFBTTtJQUNQLENBQUMsYUFBYTtJQUNkLENBQUMsR0FBRztLQUVKLENBQUMsYUFBYSxHQUFXLENBQUM7UUFDeEIsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxVQUFVLElBQUksQ0FBRTtJQUM3QyxDQUFDO0lBRUQsRUFPRyxBQVBIOzs7Ozs7O0dBT0csQUFQSCxFQU9HLEtBQ0MsT0FBTyxHQUFZLENBQUM7UUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHO0lBQ3ZCLENBQUM7SUFFRCxFQUE2QyxBQUE3Qyx5Q0FBNkMsQUFBN0MsRUFBNkMsS0FDekMsT0FBTyxHQUFZLENBQUM7UUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxPQUFPO0lBQ3BDLENBQUM7SUFFRCxFQUVHLEFBRkg7O0dBRUcsQUFGSCxFQUVHLEtBQ0MsRUFBRSxHQUFXLENBQUM7UUFDaEIsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxhQUFhLE9BQU8sQ0FBRTtJ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