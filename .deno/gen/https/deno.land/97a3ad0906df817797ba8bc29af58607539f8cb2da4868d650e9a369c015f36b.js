import { calculate, ifNoneMatch } from "./etag.ts";
import { createHttpError } from "./httpError.ts";
import { basename, extname, LimitedReader, parse, readAll, Status } from "./deps.ts";
import { ifRange, MultiPartStream, parseRange } from "./range.ts";
import { assert, decodeComponent, getBoundary, resolvePath } from "./util.ts";
const MAXBUFFER_DEFAULT = 1048576; // 1MiB;
const BOUNDARY = await getBoundary();
function isHidden(path) {
    const pathArr = path.split("/");
    for (const segment of pathArr){
        if (segment[0] === "." && segment !== "." && segment !== "..") {
            return true;
        }
        return false;
    }
}
async function exists(path) {
    try {
        return (await Deno.stat(path)).isFile;
    } catch  {
        return false;
    }
}
async function getEntity(path, mtime, stats, maxbuffer, response) {
    let body;
    let entity;
    const file = await Deno.open(path, {
        read: true
    });
    if (stats.size < maxbuffer) {
        const buffer = await readAll(file);
        file.close();
        body = entity = buffer;
    } else {
        response.addResource(file.rid);
        body = file;
        entity = {
            mtime: new Date(mtime),
            size: stats.size
        };
    }
    return [
        body,
        entity
    ];
}
async function sendRange(response, body, range, size) {
    const ranges = parseRange(range, size);
    if (ranges.length === 0) {
        throw createHttpError(Status.RequestedRangeNotSatisfiable);
    }
    response.status = Status.PartialContent;
    if (ranges.length === 1) {
        const [byteRange] = ranges;
        response.headers.set("Content-Length", String(byteRange.end - byteRange.start + 1));
        response.headers.set("Content-Range", `bytes ${byteRange.start}-${byteRange.end}/${size}`);
        if (body instanceof Uint8Array) {
            response.body = body.slice(byteRange.start, byteRange.end + 1);
        } else {
            await body.seek(byteRange.start, Deno.SeekMode.Start);
            response.body = new LimitedReader(body, byteRange.end - byteRange.start + 1);
        }
    } else {
        assert(response.type);
        response.headers.set("content-type", `multipart/byteranges; boundary=${BOUNDARY}`);
        const multipartBody = new MultiPartStream(body, response.type, ranges, size, BOUNDARY);
        response.headers.set("content-length", String(multipartBody.contentLength()));
        response.body = multipartBody;
    }
}
/** Asynchronously fulfill a response with a file from the local file
 * system.
 *
 * Requires Deno read permission for the `root` directory. */ export async function send(// deno-lint-ignore no-explicit-any
{ request , response  }, path, options = {
    root: ""
}) {
    const { brotli =true , contentTypes ={
    } , extensions , format =true , gzip =true , hidden =false , immutable =false , index , maxbuffer =MAXBUFFER_DEFAULT , maxage =0 , root ,  } = options;
    const trailingSlash = path[path.length - 1] === "/";
    path = decodeComponent(path.substr(parse(path).root.length));
    if (index && trailingSlash) {
        path += index;
    }
    if (!hidden && isHidden(path)) {
        throw createHttpError(403);
    }
    path = resolvePath(root, path);
    let encodingExt = "";
    if (brotli && request.acceptsEncodings("br", "identity") === "br" && await exists(`${path}.br`)) {
        path = `${path}.br`;
        response.headers.set("Content-Encoding", "br");
        response.headers.delete("Content-Length");
        encodingExt = ".br";
    } else if (gzip && request.acceptsEncodings("gzip", "identity") === "gzip" && await exists(`${path}.gz`)) {
        path = `${path}.gz`;
        response.headers.set("Content-Encoding", "gzip");
        response.headers.delete("Content-Length");
        encodingExt = ".gz";
    }
    if (extensions && !/\.[^/]*$/.exec(path)) {
        for (let ext of extensions){
            if (!/^\./.exec(ext)) {
                ext = `.${ext}`;
            }
            if (await exists(`${path}${ext}`)) {
                path += ext;
                break;
            }
        }
    }
    let stats;
    try {
        stats = await Deno.stat(path);
        if (stats.isDirectory) {
            if (format && index) {
                path += `/${index}`;
                stats = await Deno.stat(path);
            } else {
                return;
            }
        }
    } catch (err) {
        if (err instanceof Deno.errors.NotFound) {
            throw createHttpError(404, err.message);
        }
        throw createHttpError(500, err instanceof Error ? err.message : "[non-error thrown]");
    }
    let mtime = null;
    if (response.headers.has("Last-Modified")) {
        mtime = new Date(response.headers.get("Last-Modified")).getTime();
    } else if (stats.mtime) {
        // Round down to second because it's the precision of the UTC string.
        mtime = stats.mtime.getTime();
        mtime -= mtime % 1000;
        response.headers.set("Last-Modified", new Date(mtime).toUTCString());
    }
    if (!response.headers.has("Cache-Control")) {
        const directives = [
            `max-age=${maxage / 1000 | 0}`
        ];
        if (immutable) {
            directives.push("immutable");
        }
        response.headers.set("Cache-Control", directives.join(","));
    }
    if (!response.type) {
        response.type = encodingExt !== "" ? extname(basename(path, encodingExt)) : contentTypes[extname(path)] ?? extname(path);
    }
    let entity = null;
    let body = null;
    if (request.headers.has("If-None-Match") && mtime) {
        [body, entity] = await getEntity(path, mtime, stats, maxbuffer, response);
        if (!await ifNoneMatch(request.headers.get("If-None-Match"), entity)) {
            response.headers.set("ETag", await calculate(entity));
            response.status = 304;
            return path;
        }
    }
    if (request.headers.has("If-Modified-Since") && mtime) {
        const ifModifiedSince = new Date(request.headers.get("If-Modified-Since"));
        if (ifModifiedSince.getTime() >= mtime) {
            response.status = 304;
            return path;
        }
    }
    if (!body || !entity) {
        [body, entity] = await getEntity(path, mtime ?? 0, stats, maxbuffer, response);
    }
    if (request.headers.has("If-Range") && mtime && await ifRange(request.headers.get("If-Range"), mtime, entity) && request.headers.has("Range")) {
        await sendRange(response, body, request.headers.get("Range"), stats.size);
        return path;
    }
    if (request.headers.has("Range")) {
        await sendRange(response, body, request.headers.get("Range"), stats.size);
        return path;
    }
    response.headers.set("Content-Length", String(stats.size));
    response.body = body;
    if (!response.headers.has("ETag")) {
        response.headers.set("ETag", await calculate(entity));
    }
    if (!response.headers.has("Accept-Ranges")) {
        response.headers.set("Accept-Ranges", "bytes");
    }
    return path;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrQHYxMC4xLjAvc2VuZC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEFkYXB0ZWQgZnJvbSBrb2Etc2VuZCBhdCBodHRwczovL2dpdGh1Yi5jb20va29hanMvc2VuZCBhbmQgd2hpY2ggaXMgbGljZW5zZWRcbiAqIHdpdGggdGhlIE1JVCBsaWNlbnNlLlxuICovXG5cbmltcG9ydCB0eXBlIHsgQ29udGV4dCB9IGZyb20gXCIuL2NvbnRleHQudHNcIjtcbmltcG9ydCB7IGNhbGN1bGF0ZSwgRmlsZUluZm8sIGlmTm9uZU1hdGNoIH0gZnJvbSBcIi4vZXRhZy50c1wiO1xuaW1wb3J0IHsgY3JlYXRlSHR0cEVycm9yIH0gZnJvbSBcIi4vaHR0cEVycm9yLnRzXCI7XG5pbXBvcnQge1xuICBiYXNlbmFtZSxcbiAgZXh0bmFtZSxcbiAgTGltaXRlZFJlYWRlcixcbiAgcGFyc2UsXG4gIHJlYWRBbGwsXG4gIFN0YXR1cyxcbn0gZnJvbSBcIi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgaWZSYW5nZSwgTXVsdGlQYXJ0U3RyZWFtLCBwYXJzZVJhbmdlIH0gZnJvbSBcIi4vcmFuZ2UudHNcIjtcbmltcG9ydCB0eXBlIHsgUmVzcG9uc2UgfSBmcm9tIFwiLi9yZXNwb25zZS50c1wiO1xuaW1wb3J0IHsgYXNzZXJ0LCBkZWNvZGVDb21wb25lbnQsIGdldEJvdW5kYXJ5LCByZXNvbHZlUGF0aCB9IGZyb20gXCIuL3V0aWwudHNcIjtcblxuY29uc3QgTUFYQlVGRkVSX0RFRkFVTFQgPSAxXzA0OF81NzY7IC8vIDFNaUI7XG5jb25zdCBCT1VOREFSWSA9IGF3YWl0IGdldEJvdW5kYXJ5KCk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VuZE9wdGlvbnMge1xuICAvKiogVHJ5IHRvIHNlcnZlIHRoZSBicm90bGkgdmVyc2lvbiBvZiBhIGZpbGUgYXV0b21hdGljYWxseSB3aGVuIGJyb3RsaSBpc1xuICAgKiBzdXBwb3J0ZWQgYnkgYSBjbGllbnQgYW5kIGlmIHRoZSByZXF1ZXN0ZWQgZmlsZSB3aXRoIGAuYnJgIGV4dGVuc2lvblxuICAgKiBleGlzdHMuIChkZWZhdWx0cyB0byBgdHJ1ZWApICovXG4gIGJyb3RsaT86IGJvb2xlYW47XG5cbiAgLyoqIEEgcmVjb3JkIG9mIGV4dGVuc2lvbnMgYW5kIGNvbnRlbnQgdHlwZXMgdGhhdCBzaG91bGQgYmUgdXNlZCB3aGVuXG4gICAqIGRldGVybWluaW5nIHRoZSBjb250ZW50IG9mIGEgZmlsZSBiZWluZyBzZXJ2ZWQuIEJ5IGRlZmF1bHQsIHRoZVxuICAgKiBbYG1lZGlhX3R5cGVgXShodHRwczovL2dpdGh1Yi5jb20vb2Frc2VydmVyL21lZGlhX3R5cGVzLykgZGF0YWJhc2UgaXMgdXNlZFxuICAgKiB0byBtYXAgYW4gZXh0ZW5zaW9uIHRvIHRoZSBzZXJ2ZWQgY29udGVudC10eXBlLiBUaGUga2V5cyBvZiB0aGUgbWFwIGFyZVxuICAgKiBleHRlbnNpb25zLCBhbmQgdmFsdWVzIGFyZSB0aGUgY29udGVudCB0eXBlcyB0byB1c2UuIFRoZSBjb250ZW50IHR5cGUgY2FuXG4gICAqIGJlIGEgcGFydGlhbCBjb250ZW50IHR5cGUsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgdG8gYSBmdWxsIGNvbnRlbnQgdHlwZVxuICAgKiBoZWFkZXIuXG4gICAqXG4gICAqIEFueSBleHRlbnNpb25zIG1hdGNoZWQgd2lsbCBvdmVycmlkZSB0aGUgZGVmYXVsdCBiZWhhdmlvci4gS2V5IHNob3VsZFxuICAgKiBpbmNsdWRlIHRoZSBsZWFkaW5nIGRvdCAoZS5nLiBgLmV4dGAgaW5zdGVhZCBvZiBqdXN0IGBleHRgKS5cbiAgICpcbiAgICogIyMjIEV4YW1wbGVcbiAgICpcbiAgICogYGBgdHNcbiAgICogYXBwLnVzZSgoY3R4KSA9PiB7XG4gICAqICAgcmV0dXJuIHNlbmQoY3R4LCBjdHgucmVxdWVzdC51cmwucGF0aG5hbWUsIHtcbiAgICogICAgIGNvbnRlbnRUeXBlczoge1xuICAgKiAgICAgICBcIi5pbXBvcnRtYXBcIjogXCJhcHBsaWNhdGlvbi9pbXBvcnRtYXAranNvblwiXG4gICAqICAgICB9LFxuICAgKiAgICAgcm9vdDogXCIuXCIsXG4gICAqICAgfSlcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgY29udGVudFR5cGVzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcblxuICAvKiogVHJ5IHRvIG1hdGNoIGV4dGVuc2lvbnMgZnJvbSBwYXNzZWQgYXJyYXkgdG8gc2VhcmNoIGZvciBmaWxlIHdoZW4gbm9cbiAgICogZXh0ZW5zaW9uIGlzIHN1ZmZpY2VkIGluIFVSTC4gRmlyc3QgZm91bmQgaXMgc2VydmVkLiAoZGVmYXVsdHMgdG9cbiAgICogYHVuZGVmaW5lZGApICovXG4gIGV4dGVuc2lvbnM/OiBzdHJpbmdbXTtcblxuICAvKiogSWYgYHRydWVgLCBmb3JtYXQgdGhlIHBhdGggdG8gc2VydmUgc3RhdGljIGZpbGUgc2VydmVycyBhbmQgbm90IHJlcXVpcmUgYVxuICAgKiB0cmFpbGluZyBzbGFzaCBmb3IgZGlyZWN0b3JpZXMsIHNvIHRoYXQgeW91IGNhbiBkbyBib3RoIGAvZGlyZWN0b3J5YCBhbmRcbiAgICogYC9kaXJlY3RvcnkvYC4gKGRlZmF1bHRzIHRvIGB0cnVlYCkgKi9cbiAgZm9ybWF0PzogYm9vbGVhbjtcblxuICAvKiogVHJ5IHRvIHNlcnZlIHRoZSBnemlwcGVkIHZlcnNpb24gb2YgYSBmaWxlIGF1dG9tYXRpY2FsbHkgd2hlbiBnemlwIGlzXG4gICAqIHN1cHBvcnRlZCBieSBhIGNsaWVudCBhbmQgaWYgdGhlIHJlcXVlc3RlZCBmaWxlIHdpdGggYC5nemAgZXh0ZW5zaW9uXG4gICAqIGV4aXN0cy4gKGRlZmF1bHRzIHRvIGB0cnVlYCkuICovXG4gIGd6aXA/OiBib29sZWFuO1xuXG4gIC8qKiBBbGxvdyB0cmFuc2ZlciBvZiBoaWRkZW4gZmlsZXMuIChkZWZhdWx0cyB0byBgZmFsc2VgKSAqL1xuICBoaWRkZW4/OiBib29sZWFuO1xuXG4gIC8qKiBUZWxsIHRoZSBicm93c2VyIHRoZSByZXNvdXJjZSBpcyBpbW11dGFibGUgYW5kIGNhbiBiZSBjYWNoZWRcbiAgICogaW5kZWZpbml0ZWx5LiAoZGVmYXVsdHMgdG8gYGZhbHNlYCkgKi9cbiAgaW1tdXRhYmxlPzogYm9vbGVhbjtcblxuICAvKiogTmFtZSBvZiB0aGUgaW5kZXggZmlsZSB0byBzZXJ2ZSBhdXRvbWF0aWNhbGx5IHdoZW4gdmlzaXRpbmcgdGhlIHJvb3RcbiAgICogbG9jYXRpb24uIChkZWZhdWx0cyB0byBub25lKSAqL1xuICBpbmRleD86IHN0cmluZztcblxuICAvKiogQnJvd3NlciBjYWNoZSBtYXgtYWdlIGluIG1pbGxpc2Vjb25kcy4gKGRlZmF1bHRzIHRvIGAwYCkgKi9cbiAgbWF4YWdlPzogbnVtYmVyO1xuXG4gIC8qKiBBIHNpemUgaW4gYnl0ZXMgd2hlcmUgaWYgdGhlIGZpbGUgaXMgbGVzcyB0aGFuIHRoaXMgc2l6ZSwgdGhlIGZpbGUgd2lsbFxuICAgKiBiZSByZWFkIGludG8gbWVtb3J5IGJ5IHNlbmQgaW5zdGVhZCBvZiByZXR1cm5pbmcgYSBmaWxlIGhhbmRsZS4gIEZpbGVzIGxlc3NcbiAgICogdGhhbiB0aGUgYnl0ZSBzaXplIHdpbGwgc2VuZCBhbiBcInN0cm9uZ1wiIGBFVGFnYCBoZWFkZXIgd2hpbGUgdGhvc2UgbGFyZ2VyXG4gICAqIHRoYW4gdGhlIGJ5dGVzIHNpemUgd2lsbCBvbmx5IGJlIGFibGUgdG8gc2VuZCBhIFwid2Vha1wiIGBFVGFnYCBoZWFkZXIgKGFzXG4gICAqIHRoZXkgY2Fubm90IGhhc2ggdGhlIGNvbnRlbnRzIG9mIHRoZSBmaWxlKS4gKGRlZmF1bHRzIHRvIDFNaUIpXG4gICAqL1xuICBtYXhidWZmZXI/OiBudW1iZXI7XG5cbiAgLyoqIFJvb3QgZGlyZWN0b3J5IHRvIHJlc3RyaWN0IGZpbGUgYWNjZXNzLiAqL1xuICByb290OiBzdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGlzSGlkZGVuKHBhdGg6IHN0cmluZykge1xuICBjb25zdCBwYXRoQXJyID0gcGF0aC5zcGxpdChcIi9cIik7XG4gIGZvciAoY29uc3Qgc2VnbWVudCBvZiBwYXRoQXJyKSB7XG4gICAgaWYgKHNlZ21lbnRbMF0gPT09IFwiLlwiICYmIHNlZ21lbnQgIT09IFwiLlwiICYmIHNlZ21lbnQgIT09IFwiLi5cIikge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBleGlzdHMocGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIChhd2FpdCBEZW5vLnN0YXQocGF0aCkpLmlzRmlsZTtcbiAgfSBjYXRjaCB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEVudGl0eShcbiAgcGF0aDogc3RyaW5nLFxuICBtdGltZTogbnVtYmVyLFxuICBzdGF0czogRGVuby5GaWxlSW5mbyxcbiAgbWF4YnVmZmVyOiBudW1iZXIsXG4gIHJlc3BvbnNlOiBSZXNwb25zZSxcbik6IFByb21pc2U8W1VpbnQ4QXJyYXkgfCBEZW5vLkZpbGUsIFVpbnQ4QXJyYXkgfCBGaWxlSW5mb10+IHtcbiAgbGV0IGJvZHk6IFVpbnQ4QXJyYXkgfCBEZW5vLkZpbGU7XG4gIGxldCBlbnRpdHk6IFVpbnQ4QXJyYXkgfCBGaWxlSW5mbztcbiAgY29uc3QgZmlsZSA9IGF3YWl0IERlbm8ub3BlbihwYXRoLCB7IHJlYWQ6IHRydWUgfSk7XG4gIGlmIChzdGF0cy5zaXplIDwgbWF4YnVmZmVyKSB7XG4gICAgY29uc3QgYnVmZmVyID0gYXdhaXQgcmVhZEFsbChmaWxlKTtcbiAgICBmaWxlLmNsb3NlKCk7XG4gICAgYm9keSA9IGVudGl0eSA9IGJ1ZmZlcjtcbiAgfSBlbHNlIHtcbiAgICByZXNwb25zZS5hZGRSZXNvdXJjZShmaWxlLnJpZCk7XG4gICAgYm9keSA9IGZpbGU7XG4gICAgZW50aXR5ID0ge1xuICAgICAgbXRpbWU6IG5ldyBEYXRlKG10aW1lISksXG4gICAgICBzaXplOiBzdGF0cy5zaXplLFxuICAgIH07XG4gIH1cbiAgcmV0dXJuIFtib2R5LCBlbnRpdHldO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZW5kUmFuZ2UoXG4gIHJlc3BvbnNlOiBSZXNwb25zZSxcbiAgYm9keTogVWludDhBcnJheSB8IERlbm8uRmlsZSxcbiAgcmFuZ2U6IHN0cmluZyxcbiAgc2l6ZTogbnVtYmVyLFxuKSB7XG4gIGNvbnN0IHJhbmdlcyA9IHBhcnNlUmFuZ2UocmFuZ2UsIHNpemUpO1xuICBpZiAocmFuZ2VzLmxlbmd0aCA9PT0gMCkge1xuICAgIHRocm93IGNyZWF0ZUh0dHBFcnJvcihTdGF0dXMuUmVxdWVzdGVkUmFuZ2VOb3RTYXRpc2ZpYWJsZSk7XG4gIH1cbiAgcmVzcG9uc2Uuc3RhdHVzID0gU3RhdHVzLlBhcnRpYWxDb250ZW50O1xuICBpZiAocmFuZ2VzLmxlbmd0aCA9PT0gMSkge1xuICAgIGNvbnN0IFtieXRlUmFuZ2VdID0gcmFuZ2VzO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFxuICAgICAgXCJDb250ZW50LUxlbmd0aFwiLFxuICAgICAgU3RyaW5nKGJ5dGVSYW5nZS5lbmQgLSBieXRlUmFuZ2Uuc3RhcnQgKyAxKSxcbiAgICApO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFxuICAgICAgXCJDb250ZW50LVJhbmdlXCIsXG4gICAgICBgYnl0ZXMgJHtieXRlUmFuZ2Uuc3RhcnR9LSR7Ynl0ZVJhbmdlLmVuZH0vJHtzaXplfWAsXG4gICAgKTtcbiAgICBpZiAoYm9keSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHtcbiAgICAgIHJlc3BvbnNlLmJvZHkgPSBib2R5LnNsaWNlKGJ5dGVSYW5nZS5zdGFydCwgYnl0ZVJhbmdlLmVuZCArIDEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCBib2R5LnNlZWsoYnl0ZVJhbmdlLnN0YXJ0LCBEZW5vLlNlZWtNb2RlLlN0YXJ0KTtcbiAgICAgIHJlc3BvbnNlLmJvZHkgPSBuZXcgTGltaXRlZFJlYWRlcihcbiAgICAgICAgYm9keSxcbiAgICAgICAgYnl0ZVJhbmdlLmVuZCAtIGJ5dGVSYW5nZS5zdGFydCArIDEsXG4gICAgICApO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBhc3NlcnQocmVzcG9uc2UudHlwZSk7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXG4gICAgICBcImNvbnRlbnQtdHlwZVwiLFxuICAgICAgYG11bHRpcGFydC9ieXRlcmFuZ2VzOyBib3VuZGFyeT0ke0JPVU5EQVJZfWAsXG4gICAgKTtcbiAgICBjb25zdCBtdWx0aXBhcnRCb2R5ID0gbmV3IE11bHRpUGFydFN0cmVhbShcbiAgICAgIGJvZHksXG4gICAgICByZXNwb25zZS50eXBlLFxuICAgICAgcmFuZ2VzLFxuICAgICAgc2l6ZSxcbiAgICAgIEJPVU5EQVJZLFxuICAgICk7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXG4gICAgICBcImNvbnRlbnQtbGVuZ3RoXCIsXG4gICAgICBTdHJpbmcobXVsdGlwYXJ0Qm9keS5jb250ZW50TGVuZ3RoKCkpLFxuICAgICk7XG4gICAgcmVzcG9uc2UuYm9keSA9IG11bHRpcGFydEJvZHk7XG4gIH1cbn1cblxuLyoqIEFzeW5jaHJvbm91c2x5IGZ1bGZpbGwgYSByZXNwb25zZSB3aXRoIGEgZmlsZSBmcm9tIHRoZSBsb2NhbCBmaWxlXG4gKiBzeXN0ZW0uXG4gKlxuICogUmVxdWlyZXMgRGVubyByZWFkIHBlcm1pc3Npb24gZm9yIHRoZSBgcm9vdGAgZGlyZWN0b3J5LiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmQoXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIHsgcmVxdWVzdCwgcmVzcG9uc2UgfTogQ29udGV4dDxhbnk+LFxuICBwYXRoOiBzdHJpbmcsXG4gIG9wdGlvbnM6IFNlbmRPcHRpb25zID0geyByb290OiBcIlwiIH0sXG4pOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICBjb25zdCB7XG4gICAgYnJvdGxpID0gdHJ1ZSxcbiAgICBjb250ZW50VHlwZXMgPSB7fSxcbiAgICBleHRlbnNpb25zLFxuICAgIGZvcm1hdCA9IHRydWUsXG4gICAgZ3ppcCA9IHRydWUsXG4gICAgaGlkZGVuID0gZmFsc2UsXG4gICAgaW1tdXRhYmxlID0gZmFsc2UsXG4gICAgaW5kZXgsXG4gICAgbWF4YnVmZmVyID0gTUFYQlVGRkVSX0RFRkFVTFQsXG4gICAgbWF4YWdlID0gMCxcbiAgICByb290LFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgdHJhaWxpbmdTbGFzaCA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXSA9PT0gXCIvXCI7XG4gIHBhdGggPSBkZWNvZGVDb21wb25lbnQocGF0aC5zdWJzdHIocGFyc2UocGF0aCkucm9vdC5sZW5ndGgpKTtcbiAgaWYgKGluZGV4ICYmIHRyYWlsaW5nU2xhc2gpIHtcbiAgICBwYXRoICs9IGluZGV4O1xuICB9XG5cbiAgaWYgKCFoaWRkZW4gJiYgaXNIaWRkZW4ocGF0aCkpIHtcbiAgICB0aHJvdyBjcmVhdGVIdHRwRXJyb3IoNDAzKTtcbiAgfVxuXG4gIHBhdGggPSByZXNvbHZlUGF0aChyb290LCBwYXRoKTtcblxuICBsZXQgZW5jb2RpbmdFeHQgPSBcIlwiO1xuICBpZiAoXG4gICAgYnJvdGxpICYmXG4gICAgcmVxdWVzdC5hY2NlcHRzRW5jb2RpbmdzKFwiYnJcIiwgXCJpZGVudGl0eVwiKSA9PT0gXCJiclwiICYmXG4gICAgKGF3YWl0IGV4aXN0cyhgJHtwYXRofS5icmApKVxuICApIHtcbiAgICBwYXRoID0gYCR7cGF0aH0uYnJgO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiQ29udGVudC1FbmNvZGluZ1wiLCBcImJyXCIpO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuZGVsZXRlKFwiQ29udGVudC1MZW5ndGhcIik7XG4gICAgZW5jb2RpbmdFeHQgPSBcIi5iclwiO1xuICB9IGVsc2UgaWYgKFxuICAgIGd6aXAgJiZcbiAgICByZXF1ZXN0LmFjY2VwdHNFbmNvZGluZ3MoXCJnemlwXCIsIFwiaWRlbnRpdHlcIikgPT09IFwiZ3ppcFwiICYmXG4gICAgKGF3YWl0IGV4aXN0cyhgJHtwYXRofS5nemApKVxuICApIHtcbiAgICBwYXRoID0gYCR7cGF0aH0uZ3pgO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiQ29udGVudC1FbmNvZGluZ1wiLCBcImd6aXBcIik7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5kZWxldGUoXCJDb250ZW50LUxlbmd0aFwiKTtcbiAgICBlbmNvZGluZ0V4dCA9IFwiLmd6XCI7XG4gIH1cblxuICBpZiAoZXh0ZW5zaW9ucyAmJiAhL1xcLlteL10qJC8uZXhlYyhwYXRoKSkge1xuICAgIGZvciAobGV0IGV4dCBvZiBleHRlbnNpb25zKSB7XG4gICAgICBpZiAoIS9eXFwuLy5leGVjKGV4dCkpIHtcbiAgICAgICAgZXh0ID0gYC4ke2V4dH1gO1xuICAgICAgfVxuICAgICAgaWYgKGF3YWl0IGV4aXN0cyhgJHtwYXRofSR7ZXh0fWApKSB7XG4gICAgICAgIHBhdGggKz0gZXh0O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsZXQgc3RhdHM6IERlbm8uRmlsZUluZm87XG4gIHRyeSB7XG4gICAgc3RhdHMgPSBhd2FpdCBEZW5vLnN0YXQocGF0aCk7XG5cbiAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkpIHtcbiAgICAgIGlmIChmb3JtYXQgJiYgaW5kZXgpIHtcbiAgICAgICAgcGF0aCArPSBgLyR7aW5kZXh9YDtcbiAgICAgICAgc3RhdHMgPSBhd2FpdCBEZW5vLnN0YXQocGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuTm90Rm91bmQpIHtcbiAgICAgIHRocm93IGNyZWF0ZUh0dHBFcnJvcig0MDQsIGVyci5tZXNzYWdlKTtcbiAgICB9XG4gICAgdGhyb3cgY3JlYXRlSHR0cEVycm9yKFxuICAgICAgNTAwLFxuICAgICAgZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6IFwiW25vbi1lcnJvciB0aHJvd25dXCIsXG4gICAgKTtcbiAgfVxuXG4gIGxldCBtdGltZTogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIGlmIChyZXNwb25zZS5oZWFkZXJzLmhhcyhcIkxhc3QtTW9kaWZpZWRcIikpIHtcbiAgICBtdGltZSA9IG5ldyBEYXRlKHJlc3BvbnNlLmhlYWRlcnMuZ2V0KFwiTGFzdC1Nb2RpZmllZFwiKSEpLmdldFRpbWUoKTtcbiAgfSBlbHNlIGlmIChzdGF0cy5tdGltZSkge1xuICAgIC8vIFJvdW5kIGRvd24gdG8gc2Vjb25kIGJlY2F1c2UgaXQncyB0aGUgcHJlY2lzaW9uIG9mIHRoZSBVVEMgc3RyaW5nLlxuICAgIG10aW1lID0gc3RhdHMubXRpbWUuZ2V0VGltZSgpO1xuICAgIG10aW1lIC09IG10aW1lICUgMTAwMDtcbiAgICByZXNwb25zZS5oZWFkZXJzLnNldChcIkxhc3QtTW9kaWZpZWRcIiwgbmV3IERhdGUobXRpbWUpLnRvVVRDU3RyaW5nKCkpO1xuICB9XG5cbiAgaWYgKCFyZXNwb25zZS5oZWFkZXJzLmhhcyhcIkNhY2hlLUNvbnRyb2xcIikpIHtcbiAgICBjb25zdCBkaXJlY3RpdmVzID0gW2BtYXgtYWdlPSR7KG1heGFnZSAvIDEwMDApIHwgMH1gXTtcbiAgICBpZiAoaW1tdXRhYmxlKSB7XG4gICAgICBkaXJlY3RpdmVzLnB1c2goXCJpbW11dGFibGVcIik7XG4gICAgfVxuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiQ2FjaGUtQ29udHJvbFwiLCBkaXJlY3RpdmVzLmpvaW4oXCIsXCIpKTtcbiAgfVxuICBpZiAoIXJlc3BvbnNlLnR5cGUpIHtcbiAgICByZXNwb25zZS50eXBlID0gZW5jb2RpbmdFeHQgIT09IFwiXCJcbiAgICAgID8gZXh0bmFtZShiYXNlbmFtZShwYXRoLCBlbmNvZGluZ0V4dCkpXG4gICAgICA6IGNvbnRlbnRUeXBlc1tleHRuYW1lKHBhdGgpXSA/PyBleHRuYW1lKHBhdGgpO1xuICB9XG5cbiAgbGV0IGVudGl0eTogVWludDhBcnJheSB8IEZpbGVJbmZvIHwgbnVsbCA9IG51bGw7XG4gIGxldCBib2R5OiBVaW50OEFycmF5IHwgRGVuby5GaWxlIHwgbnVsbCA9IG51bGw7XG5cbiAgaWYgKHJlcXVlc3QuaGVhZGVycy5oYXMoXCJJZi1Ob25lLU1hdGNoXCIpICYmIG10aW1lKSB7XG4gICAgW2JvZHksIGVudGl0eV0gPSBhd2FpdCBnZXRFbnRpdHkocGF0aCwgbXRpbWUsIHN0YXRzLCBtYXhidWZmZXIsIHJlc3BvbnNlKTtcbiAgICBpZiAoIWF3YWl0IGlmTm9uZU1hdGNoKHJlcXVlc3QuaGVhZGVycy5nZXQoXCJJZi1Ob25lLU1hdGNoXCIpISwgZW50aXR5KSkge1xuICAgICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXCJFVGFnXCIsIGF3YWl0IGNhbGN1bGF0ZShlbnRpdHkpKTtcbiAgICAgIHJlc3BvbnNlLnN0YXR1cyA9IDMwNDtcbiAgICAgIHJldHVybiBwYXRoO1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZXF1ZXN0LmhlYWRlcnMuaGFzKFwiSWYtTW9kaWZpZWQtU2luY2VcIikgJiYgbXRpbWUpIHtcbiAgICBjb25zdCBpZk1vZGlmaWVkU2luY2UgPSBuZXcgRGF0ZShyZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiSWYtTW9kaWZpZWQtU2luY2VcIikhKTtcbiAgICBpZiAoaWZNb2RpZmllZFNpbmNlLmdldFRpbWUoKSA+PSBtdGltZSkge1xuICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gMzA0O1xuICAgICAgcmV0dXJuIHBhdGg7XG4gICAgfVxuICB9XG5cbiAgaWYgKCFib2R5IHx8ICFlbnRpdHkpIHtcbiAgICBbYm9keSwgZW50aXR5XSA9IGF3YWl0IGdldEVudGl0eShcbiAgICAgIHBhdGgsXG4gICAgICBtdGltZSA/PyAwLFxuICAgICAgc3RhdHMsXG4gICAgICBtYXhidWZmZXIsXG4gICAgICByZXNwb25zZSxcbiAgICApO1xuICB9XG5cbiAgaWYgKFxuICAgIHJlcXVlc3QuaGVhZGVycy5oYXMoXCJJZi1SYW5nZVwiKSAmJiBtdGltZSAmJlxuICAgIGF3YWl0IGlmUmFuZ2UocmVxdWVzdC5oZWFkZXJzLmdldChcIklmLVJhbmdlXCIpISwgbXRpbWUsIGVudGl0eSkgJiZcbiAgICByZXF1ZXN0LmhlYWRlcnMuaGFzKFwiUmFuZ2VcIilcbiAgKSB7XG4gICAgYXdhaXQgc2VuZFJhbmdlKHJlc3BvbnNlLCBib2R5LCByZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiUmFuZ2VcIikhLCBzdGF0cy5zaXplKTtcbiAgICByZXR1cm4gcGF0aDtcbiAgfVxuXG4gIGlmIChyZXF1ZXN0LmhlYWRlcnMuaGFzKFwiUmFuZ2VcIikpIHtcbiAgICBhd2FpdCBzZW5kUmFuZ2UocmVzcG9uc2UsIGJvZHksIHJlcXVlc3QuaGVhZGVycy5nZXQoXCJSYW5nZVwiKSEsIHN0YXRzLnNpemUpO1xuICAgIHJldHVybiBwYXRoO1xuICB9XG5cbiAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXCJDb250ZW50LUxlbmd0aFwiLCBTdHJpbmcoc3RhdHMuc2l6ZSkpO1xuICByZXNwb25zZS5ib2R5ID0gYm9keTtcblxuICBpZiAoIXJlc3BvbnNlLmhlYWRlcnMuaGFzKFwiRVRhZ1wiKSkge1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiRVRhZ1wiLCBhd2FpdCBjYWxjdWxhdGUoZW50aXR5KSk7XG4gIH1cblxuICBpZiAoIXJlc3BvbnNlLmhlYWRlcnMuaGFzKFwiQWNjZXB0LVJhbmdlc1wiKSkge1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiQWNjZXB0LVJhbmdlc1wiLCBcImJ5dGVzXCIpO1xuICB9XG5cbiAgcmV0dXJuIHBhdGg7XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBTUEsTUFBTSxHQUFHLFNBQVMsRUFBWSxXQUFXLFFBQVEsQ0FBVztBQUM1RCxNQUFNLEdBQUcsZUFBZSxRQUFRLENBQWdCO0FBQ2hELE1BQU0sR0FD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